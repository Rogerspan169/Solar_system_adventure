<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Card Supply Game</title>

<style>
body{
  margin:0;
  background:#000;
  font-family:'Noto Sans TC',sans-serif;
  color:#fff;
}

#game-screen{
  position:relative;
  width:100%;
  height:100vh;
}

/* ===== HUD ===== */
#hud{
  position:absolute;
  top:10px;
  left:50%;
  transform:translateX(-50%);
  display:flex;
  gap:14px;
  align-items:center;
  justify-content:center;
  flex-wrap:wrap;
  z-index:3;
  font-size:1.05em;
}

.hud-chip{
  background:rgba(255,255,255,0.08);
  border:1px solid rgba(255,255,255,0.12);
  border-radius:999px;
  padding:8px 12px;
  white-space:nowrap;
}

/* ===== æç¤º ===== */
#toast{
  position:absolute;
  bottom: calc(32vh + 2vh + 10px);
  left:50%;
  transform:translateX(-50%);
  background:rgba(0,0,0,0.75);
  padding:0.8em 1.5em;
  border-radius:12px;
  font-size:1.2em;
  opacity:0;
  pointer-events:none;
  transition:opacity 0.25s ease;
  z-index:4;
}
#toast.show{ opacity:1; }

/* ===== æ‰‹ç‰Œå€ï¼ˆå·¦æ‰‹ç‰Œ + å³å´æŒ‰éˆ•ï¼‰ ===== */
#hand-area{
  position:absolute;
  bottom:0;
  width:100%;
  height:32vh;
  display:flex;
  justify-content:center;
  align-items:flex-end;
  padding:0 3vw 2vh;
  box-sizing:border-box;
  z-index:2;
}

/* å·¦é‚Šï¼šæ‰‹ç‰Œå®¹å™¨ */
#hand-cards{
  display:flex;
  align-items:flex-end;
  justify-content:center;
  flex:1;
  min-width:0;
}

/* å³é‚Šï¼šæŒ‰éˆ•æ¬„ */
#hand-actions{
  width:92px;
  display:flex;
  flex-direction:column;
  gap:12px;
  align-items:stretch;
  margin-left:12px;
  padding-bottom:0px;
}

/* æŒ‰éˆ•æ¨£å¼ */
.action-btn{
  padding:0.9em 0.2em;
  font-size:1.1em;
  border-radius:14px;
  border:none;
  cursor:pointer;
  background:#1e90ff;
  color:white;
  transition:background 0.25s ease, transform 0.08s ease, opacity 0.15s ease;
  user-select:none;
  -webkit-user-select:none;
}
.action-btn:disabled{
  opacity: 0.45;
  filter: grayscale(0.2);
  cursor: not-allowed;
  transform: none;
}
.action-btn:hover{ background:#63b3ed; }
.action-btn:active{ transform:scale(0.98); }

/* æ£„ç‰Œ */
.action-btn.discard{
  background:#ff5b5b;
}
.action-btn.discard:hover{
  background:#ff8a8a;
}
.action-btn.sum{
  background:#5bff71;
}
.action-btn.sum:hover{
  background:#ff8a8a;
}

/* ===== å¡ç‰Œ ===== */
.card{
  position:relative;
  width:87.5px;
  height:122.5px;
  margin-left:-43.5px;
  transition:transform 0.2s ease;
}
.card:first-child{ margin-left:0; }

.card img{
  width:100%;
  height:100%;
  object-fit:contain;
  pointer-events:none;
}

.card.selected{
  transform:translateY(-30px);
}

/* ç–Šæ”¾é †åºï¼ˆæœ€å¤š 11 å¼µï¼‰ */
.card{ z-index:1; }
.card:nth-child(2){z-index:2}
.card:nth-child(3){z-index:3}
.card:nth-child(4){z-index:4}
.card:nth-child(5){z-index:5}
.card:nth-child(6){z-index:6}
.card:nth-child(7){z-index:7}
.card:nth-child(8){z-index:8}
.card:nth-child(9){z-index:9}
.card:nth-child(10){z-index:10}
.card:nth-child(11){z-index:11}

/* ===== å·¦ä¸Š HUD ===== */
#hud-left{
  position:absolute;
  top:10px;
  left:12px;
  right:12px;          /* âœ… é—œéµï¼šä¸ç”¨ width:min(...)ï¼Œæ”¹ç”¨å·¦å³è²¼é½Š */
  width:auto;
  z-index:6;
  pointer-events:none;
}
#hud-left *{ pointer-events:none; }

/* ===== ä¸Šæ’ 4 æ ¼å¹³å‡åˆ†é…ï¼Œçª„è¢å¹•è‡ªå‹•è®Šå…©è¡Œ ===== */
#hud-toprow{
  display:grid;
  grid-template-columns: repeat(4, minmax(0, 1fr)); /* âœ… 4 æ ¼å¹³å‡ */
  gap:10px;
  align-items:center;
}

/* æ¯æ ¼åƒæ»¿è‡ªå·±çš„æ ¼å­ */
#hud-toprow .hud-chip{
  width:100%;
  box-sizing:border-box;
}

/* çª„è¢å¹•ï¼šæ”¹æˆ 2 æ¬„ â†’ å…©è¡Œï¼ˆä»ç„¶å¹³å‡ï¼‰ */
@media (max-width: 520px){
  #hud-toprow{
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }
}

.hud-chip{
  background:rgba(255,255,255,0.08);
  border:1px solid rgba(255,255,255,0.12);
  border-radius:999px;
  padding:8px 12px;
  white-space:nowrap;
  font-size:1.05em;
  text-align: center;
}

/* ===== HP è¡€æ¢ ===== */
#hp-wrap{
  margin-top:10px;
}

#hp-bar{
  position:relative;
  height:22px;
  width:100%;
  border-radius:999px;
  background:rgba(255,255,255,0.10);
  border:1px solid rgba(255,255,255,0.14);
  overflow:hidden;
}

#hp-fill{
  position:absolute;
  left:0;
  top:0;
  height:100%;
  width:50%;
  background:rgba(255,70,70,0.85);
  transition:width 0.25s ease;
}

#hp-text{
  position:absolute;
  left:50%;
  top:50%;
  transform:translate(-50%,-50%);
  font-size:0.95em;
  font-weight:700;
  color:#fff;
  text-shadow:0 1px 2px rgba(0,0,0,0.6);
  pointer-events:none;
}

:root{
  --hud-bottom: 120px;     /* fallback */
  --hud-gap: 14px;         /* HUD èˆ‡ä¸‹ä¸€å±¤çš„é–“è· */
}
/* ===== æ˜Ÿçƒåç¨±ï¼ˆå°é—œï¼‰ ===== */
#level-name{
  position:absolute;
  top: calc(var(--hud-bottom) + var(--hud-gap));
  left:50%;
  transform:translateX(-50%);
  width:92vw;
  text-align:center;

  font-size:1.7em;
  font-weight:800;
  color:#00ffcc;
  text-shadow:0 2px 10px rgba(0,0,0,0.45);
  z-index:6;
  pointer-events:none;
}

/* ===== ä¸­å¤®æ˜Ÿçƒåœ–ç‰‡ ===== */
#planet-image{
  position:absolute;
  left:50%;
  top: calc(var(--hud-bottom) + var(--hud-gap) + 160px);
  transform:translate(-50%,-50%) scale(0.75);
  width:min(70vw, 440px);
  height:auto;
  object-fit:contain;
  z-index:1;
  opacity:0.95;
  pointer-events:none;
}

/* ===== å•†åº—åœ–æ¨™ ===== */
#shop-btn{
  position:absolute;
  top: calc(var(--hud-bottom) + var(--hud-gap) + 64px); /* åŸæœ¬ 100â†’164 å·® 64 */
  right:12px;
  width:56px;
  height:56px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,0.18);
  background:rgba(0,0,0,0.35);
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  z-index:5;
  transition:transform 0.08s ease, background 0.2s ease, opacity 0.2s ease;
  user-select:none;
  -webkit-user-select:none;
}
#shop-btn:hover{ background:rgba(255,255,255,0.10); }
#shop-btn:active{ transform:scale(0.97); }

#shop-btn img{
  width:70%;
  height:70%;
  object-fit:contain;
  pointer-events:none;
}
/* ===== å•†åº— Overlay ===== */
#shop-overlay{
  position:absolute;
  inset:0;
  background:rgba(0,0,0,0.75);
  z-index:999;
  display:none;
}
#shop-overlay.show{ display:block; }

#shop-panel{
  position:absolute;
  left:50%;
  top:50%;
  transform:translate(-50%,-50%);
  width:min(92vw, 720px);
  height:min(82vh, 860px);
  background:rgba(10,10,14,0.95);
  border:1px solid rgba(255,255,255,0.14);
  border-radius:18px;
  overflow:hidden;
  box-shadow:0 20px 70px rgba(0,0,0,0.6);
  display:flex;
  flex-direction:column;
}

/* ä¸Šæ–¹æ¨™é¡Œåˆ—ï¼ˆå«é—œé–‰ï¼‰ */
.shop-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:12px 14px;
  border-bottom:1px solid rgba(255,255,255,0.10);
}
.shop-right{
  display:flex;
  align-items:center;
  gap:10px;
}

.shop-coin{
  padding:8px 12px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,0.14);
  background:rgba(255,255,255,0.06);
  color:#ffd24e;
  font-weight:700;
  white-space:nowrap;
}
.shop-title{
  font-size:1.2em;
  font-weight:700;
  color:#00ffcc;
}
.shop-close{
  width:40px;
  height:40px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,0.18);
  background:rgba(255,255,255,0.06);
  color:#fff;
  cursor:pointer;
}
.shop-close:active{ transform:scale(0.98); }

/* åˆ†é åˆ—ï¼ˆåƒç€è¦½å™¨ tabsï¼‰ */
.tabs{
  display:flex;
  gap:8px;
  padding:10px 10px 0;
  background:rgba(255,255,255,0.03);
}
.tab{
  flex:1;
  padding:10px 8px;
  border-radius:14px 14px 0 0;
  border:1px solid rgba(255,255,255,0.12);
  background:rgba(255,255,255,0.05);
  color:#fff;
  cursor:pointer;
  font-size:1.05em;
}
.tab.active{
  background:rgba(0,255,204,0.12);
  border-color:rgba(0,255,204,0.28);
  color:#b5fff0;
}

/* å…§å®¹å€ */
.shop-body{
  flex:1;
  padding:12px 12px 14px;
  overflow:auto;
}

/* æ¬¡åˆ†é ï¼ˆå·²æ“æœ‰å…§çš„ç¬¬äºŒå±¤ tabsï¼‰ */
.subtabs{
  display:flex;
  gap:8px;
  margin-top:10px;
  margin-bottom:10px;
}
.subtab{
  flex:1;
  padding:10px 8px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,0.12);
  background:rgba(255,255,255,0.05);
  color:#fff;
  cursor:pointer;
  font-size:1.0em;
}
.subtab.active{
  background:rgba(30,144,255,0.18);
  border-color:rgba(30,144,255,0.35);
}

/* å•†å“æ ¼å­ */
.grid{
  display:grid;
  grid-template-columns:repeat(2, 1fr);
  gap:10px;
}

.item-card{
  border:1px solid rgba(255,255,255,0.12);
  background:rgba(255,255,255,0.05);
  border-radius:14px;
  padding:10px;
  min-height:88px;
  display:flex;
  flex-direction:column;
  gap:6px;
}
.item-name{
  font-weight:700;
  font-size:1.05em;
}
.item-desc{
  font-size:0.95em;
  line-height:1.35;
  color:rgba(255,255,255,0.85);
}
.item-meta{
  margin-top:auto;
  font-size:0.9em;
  color:rgba(0,255,204,0.85);
}
.item-unsellable{
  color: rgba(255,255,255,0.45);
  font-size: 0.9em;
  margin-left: auto;
  white-space: nowrap;
}

/* æ‰‹æ©Ÿæ›´çª„æ™‚ï¼šæ”¹ 1 æ¬„ */
@media (max-width: 420px){
  .grid{ grid-template-columns:1fr; }
}

/* ===== ç¢ºèªè¦–çª— ===== */
#confirm-overlay{
  position:absolute;
  inset:0;
  background:rgba(0,0,0,0.45);
  z-index:1000;
  display:flex;
  align-items:center;
  justify-content:center;
}

#confirm-box{
  width:min(86vw, 520px);
  background:rgba(10,10,14,0.96);
  border:1px solid rgba(255,255,255,0.14);
  border-radius:16px;
  padding:16px 14px;
  box-shadow:0 18px 60px rgba(0,0,0,0.65);
}

#confirm-text{
  font-size:1.15em;
  line-height:1.5;
  margin-bottom:14px;
}

#confirm-actions{
  display:flex;
  gap:10px;
  justify-content:flex-end;
}
#confirm-actions .action-btn{
  width:110px;
}

/* ===== è¦å‰‡åœ–æ¨™ï¼ˆæ”¾åœ¨å•†åº—ä¸‹é¢ï¼‰ ===== */
#rules-btn{
  position:absolute;
  top: calc(var(--hud-bottom) + var(--hud-gap));
  right:12px;
  width:56px;
  height:56px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,0.18);
  background:rgba(0,0,0,0.35);
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  z-index:5;
  transition:transform 0.08s ease, background 0.2s ease, opacity 0.2s ease;
  user-select:none;
  -webkit-user-select:none;
}
#rules-btn:hover{ background:rgba(255,255,255,0.10); }
#rules-btn:active{ transform:scale(0.97); }

#rules-btn img{
  width:70%;
  height:70%;
  object-fit:contain;
  pointer-events:none;
}

/* ===== è¦å‰‡ Overlayï¼ˆåŒå•†åº—é¢¨æ ¼/å°ºå¯¸ï¼‰ ===== */
#rules-overlay{
  position:absolute;
  inset:0;
  background:rgba(0,0,0,0.75);
  z-index:999;
  display:none;
}
#rules-overlay.show{ display:block; }

#rules-panel{
  position:absolute;
  left:50%;
  top:50%;
  transform:translate(-50%,-50%);
  width:min(92vw, 720px);
  height:min(82vh, 860px);
  background:rgba(10,10,14,0.95);
  border:1px solid rgba(255,255,255,0.14);
  border-radius:18px;
  overflow:hidden;
  box-shadow:0 20px 70px rgba(0,0,0,0.6);
  display:flex;
  flex-direction:column;
}

.rules-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:12px 14px;
  border-bottom:1px solid rgba(255,255,255,0.10);
}
.rules-title{
  font-size:1.2em;
  font-weight:700;
  color:#00ffcc;
}
.rules-close{
  width:40px;
  height:40px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,0.18);
  background:rgba(255,255,255,0.06);
  color:#fff;
  cursor:pointer;
}
.rules-close:active{ transform:scale(0.98); }

.rules-body{
  flex:1;
  padding:14px 14px 10px;
  overflow:auto;
  font-size:1.1em;
  line-height:1.6;
  color:rgba(255,255,255,0.92);
}

.rules-footer{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  padding:12px 14px;
  border-top:1px solid rgba(255,255,255,0.10);
}
.rules-footer .action-btn{
  width:140px;
}

#rules-page-indicator{
  flex:1;
  text-align:center;
  font-size:1.2em;
  opacity:0.75;
  pointer-events:none;
}

.rules-table{
  width:100%;
  border-collapse:separate;
  border-spacing:0;
  overflow:hidden;
  border-radius:12px;
  border:1px solid rgba(255,255,255,0.14);
  background:rgba(255,255,255,0.05);
}

.rules-table th,
.rules-table td{
  padding:10px 10px;
  border-bottom:1px solid rgba(255,255,255,0.10);
  font-size:0.98em;
}

.rules-table th{
  text-align:left;
  color:#b5fff0;
  background:rgba(0,255,204,0.10);
  font-weight:800;
}

.rules-table tr:last-child td{
  border-bottom:none;
}

.rules-table td{
  color:rgba(255,255,255,0.92);
}

.rules-table .num{
  text-align:middle;
  white-space:nowrap;
  color:#ffd24e;
  font-weight:800;
}

/* ===== é€šé—œå½ˆçª— ===== */
#pass-overlay{
  position:absolute;
  inset:0;
  background:rgba(0,0,0,0.45);
  z-index:1001;             /* æ¯” confirm-overlay é«˜ä¸€é»ï¼Œé¿å…äº’è“‹ */
  display:flex;
  align-items:center;
  justify-content:center;
}

#pass-box{
  width:min(86vw, 520px);
  background:rgba(10,10,14,0.96);
  border:1px solid rgba(255,255,255,0.14);
  border-radius:16px;
  padding:16px 14px;
  box-shadow:0 18px 60px rgba(0,0,0,0.65);
}

#pass-title{
  text-align: center;
  font-size:1.35em;
  font-weight:900;
  color:#00ffcc;
  margin-bottom:10px;
}

#pass-text{
  text-align: center;
  font-size:1.1em;
  line-height:1.6;
  opacity:0.92;
  margin-bottom:14px;
}

#pass-actions{
  display:flex;
  justify-content:center;
}
#pass-actions .action-btn{
  width:140px;
}

/* ===== å¤±æ•—å½ˆçª— ===== */
#fail-overlay{
  position:absolute;
  inset:0;
  background:rgba(0,0,0,0.55);
  z-index:1002; /* é«˜æ–¼é€šé—œ/confirm */
  display:flex;
  align-items:center;
  justify-content:center;
}

#fail-box{
  width:min(90vw, 560px);
  background:rgba(10,10,14,0.96);
  border:1px solid rgba(255,255,255,0.14);
  border-radius:16px;
  padding:16px 14px;
  box-shadow:0 18px 60px rgba(0,0,0,0.70);
}

#fail-title{
  text-align: center;
  font-size:1.35em;
  font-weight:900;
  color:#ff8a8a;
  margin-bottom:10px;
}

#fail-text{
  text-align: center;
  font-size:1.1em;
  line-height:1.6;
  opacity:0.92;
  margin-bottom:14px;
}

#fail-actions{
  display:flex;
  gap:10px;
  flex-direction:column;
  align-items:center;
}
#fail-actions .action-btn{
  width:170px;
}

/* =========================================================
   çŸ¥è­˜é CSS
========================================================= */
.container {
  position: relative;
  max-width: 700px;
  margin: auto;
  z-index: 1;
  padding-top: 5vh;
}

#knowledge-title {
  font-size: 2em;  /* ä½ å¯ä»¥ä¾éœ€æ±‚èª¿æ•´æ•¸å€¼ */
  font-weight: bold; /* ä¹Ÿå¯ä»¥è¨­ç‚º normal, lighter ç­‰ */
  margin-bottom: 1em;
  color: #00ffcc;
  margin-top: 0.5em;
  display: block;
  max-width: 700px;
  margin: auto;
  text-align: center;
}

.intro {
  margin-bottom: 0em;
  width: fit-content;     /* æ ¸å¿ƒï¼šè‡ªå‹•æ ¹æ“šå…§å®¹å¯¬åº¦èª¿æ•´ */
  background: rgba(0,0,0,0.5);
  padding: 0.5em;
  border-radius: 10px;
}

#knowledge-text {
  font-size: 1.5em;
  line-height: 1.6;
  margin-bottom: 1em;
  text-align: justify;
  padding: 0 1em;
  max-width: 700px;
  margin: auto;
}

#info-link {
  padding: 0 1em;
  max-width: 700px;
  margin: auto;
  text-align: center;
  line-height: 1.5em;
  margin-top: 1em;
}
#info-screen .action-btn {
  display: block; /* è®Šæˆå€å¡Šå…ƒç´  */
  margin: 0 auto; /* è‡ªå‹•å·¦å³å¤–è·ï¼Œæ°´å¹³ç½®ä¸­ */
  min-width: 120px;
}

.hidden { display: none; }

/* =========================================================
   çµå°¾é CSS
========================================================= */
h4 {
  font-size: 1.4em;
  line-height: 1.6;
  margin-top: 1em;
  margin-bottom: 1em;
}

@keyframes rainbow {
  0% { background-position: 100% 50%; }
  50% { background-position: 0% 50%; }
  100% { background-position: 100% 50%; }
}

#final-highlight {
  font-size: 2em;
  margin: 1em 0;
  font-weight: bold;
  text-align: center;
  background: linear-gradient(270deg, red, orange, yellow, green, blue, indigo, violet, red);
  background-size: 400% 400%;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  animation: rainbow 2s ease infinite;
}

  .endscore-display {
  margin-top: 1em;
  font-size: 1.8em;
  color: #00ffcc;
}

</style>
</head>

<body>

<div id="game-screen">
  <!-- ===== å·¦ä¸Š HUDï¼ˆå¤§é—œ/ç‡ƒæ–™/æ£„ç‰Œ + è¡€æ¢ + æ˜Ÿçƒåï¼‰ ===== -->
  <div id="hud-left">
    <div id="hud-toprow">
      <div class="hud-chip" id="hud-stage-text">ç¬¬ä¸€å¤§é—œ</div>
      <div class="hud-chip">ç‡ƒæ–™ï¼š<span id="hud-fuel">0</span>/<span id="hud-target">0</span></div>
      <div class="hud-chip">æ£„ç‰Œï¼š<span id="hud-discards">0</span></div>
      <div class="hud-chip">ç‰Œåº«ï¼š<span id="hud-deck">0</span></div>
    </div>

    <div id="hp-wrap">
      <div id="hp-bar">
        <div id="hp-fill"></div>
        <div id="hp-text">HP: 0/0</div>
      </div>
    </div>
  </div>
  <div id="level-name">ï¼ˆæ˜Ÿçƒåç¨±ï¼‰</div>

  <!-- ===== ç•«é¢ä¸­å¤®æ˜Ÿçƒåœ– ===== -->
  <img id="planet-image" src="" alt="planet">

  <div id="shop-btn" title="å•†åº—">
    <img id="shop-icon" src="https://raw.githubusercontent.com/BonBonChou/The_Great_Solar_System_Adventure/main/images/shop.png" alt="shop">
  </div>

  <div id="rules-btn" title="è¦å‰‡">
    <img id="rules-icon" src="https://raw.githubusercontent.com/BonBonChou/The_Great_Solar_System_Adventure/main/images/rules.png" alt="rules">
  </div>


  <div id="toast"></div>

  <div id="hand-area">
    <div id="hand-cards"></div>

    <div id="hand-actions">
      <button id="btn-play" class="action-btn">è£œçµ¦</button>
      <button id="btn-discard" class="action-btn discard">ä¸Ÿæ£„</button>
    </div>
  </div>

  <!-- ===== å•†åº— Overlay ===== -->
  <div id="shop-overlay">
    <div id="shop-panel">

      <div class="shop-header">
        <div class="shop-title">å•†åº—</div>
        <div class="shop-right">
          <div class="shop-coin">é‡‘å¹£ï¼š<span id="shop-coin">0</span></div>
          <button id="shop-close" class="shop-close">âœ•</button>
        </div>
      </div>

      <!-- ç¬¬ä¸€å±¤åˆ†é ï¼šé“å…· / æ¶ˆè€—å“ / å·²æ“æœ‰ -->
      <div class="tabs">
        <button class="tab active" data-tab="tab-tools">é“å…·</button>
        <button class="tab" data-tab="tab-consumables">æ¶ˆè€—å“</button>
        <button class="tab" data-tab="tab-owned">å·²æ“æœ‰</button>
      </div>

      <div class="shop-body">
        <!-- é“å…·åˆ†é å…§å®¹ -->
        <div id="tab-tools" class="tab-page">
          <div class="grid" id="tools-grid"></div>
        </div>

        <!-- æ¶ˆè€—å“åˆ†é å…§å®¹ -->
        <div id="tab-consumables" class="tab-page" style="display:none;">
          <div class="grid" id="consumables-grid"></div>
        </div>

        <!-- å·²æ“æœ‰åˆ†é å…§å®¹ï¼ˆå«ç¬¬äºŒå±¤ tabsï¼‰ -->
        <div id="tab-owned" class="tab-page" style="display:none;">
          <div class="subtabs">
            <button class="subtab active" data-subtab="owned-tools">é“å…·</button>
            <button class="subtab" data-subtab="owned-consumables">æ¶ˆè€—å“</button>
          </div>

          <div id="owned-tools" class="owned-page">
            <div class="grid" id="owned-tools-grid"></div>
          </div>

          <div id="owned-consumables" class="owned-page" style="display:none;">
            <div class="grid" id="owned-consumables-grid"></div>
          </div>
        </div>
      </div>

    </div>

    <!-- ===== å‡ºå”®ç¢ºèªè¦–çª— ===== -->
    <div id="confirm-overlay" style="display:none;">
      <div id="confirm-box">
        <div id="confirm-text">æ˜¯å¦å‡ºå”®XXX</div>
        <div id="confirm-actions">
          <button id="confirm-no" class="action-btn discard">å¦</button>
          <button id="confirm-yes" class="action-btn">æ˜¯</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== è¦å‰‡ Overlay ===== -->
  <div id="rules-overlay">
    <div id="rules-panel">

      <div class="rules-header">
        <div class="rules-title">ç©æ³•ä»‹ç´¹</div>
        <button id="rules-close" class="rules-close">âœ•</button>
      </div>

      <div class="rules-body" id="rules-body"></div>

      <div class="rules-footer">
        <button id="rules-prev" class="action-btn discard">ä¸Šä¸€é </button>
        <div id="rules-page-indicator">ç¬¬ 1 / 3 é </div>
        <button id="rules-next" class="action-btn">ä¸‹ä¸€é </button>
      </div>

    </div>
  </div>

  <!-- ===== é€šé—œå½ˆçª— ===== -->
  <div id="pass-overlay" style="display:none;">
    <div id="pass-box">
      <div id="pass-title">é€šé—œï¼</div>
      <div id="pass-text"></div>
      <div id="pass-actions">
        <button id="pass-continue" class="action-btn">ç¹¼çºŒ</button>
      </div>
    </div>
  </div>

  <!-- ===== å¤±æ•—å½ˆçª— ===== -->
  <div id="fail-overlay" style="display:none;">
    <div id="fail-box">
      <div id="fail-title">å¤±æ•—...</div>
      <div id="fail-text">HP æ­¸é›¶äº†ã€‚è¦æ€éº¼åšï¼Ÿ</div>
      <div id="fail-actions">
        <button id="fail-retry" class="action-btn">æœ¬é—œé‡æ–°é–‹å§‹</button>
        <button id="fail-restart" class="action-btn discard">éŠæˆ²é‡é ­é–‹å§‹</button>
        <button id="fail-summary" class="action-btn sum">éŠæˆ²çµç®—</button>
      </div>
    </div>
  </div>
</div>

<!-- =========================================================
   çŸ¥è­˜é 
========================================================= -->
<div class="container">
  <div id="info-screen" class="hidden">
    <h3 id="knowledge-title"></h3>
    <div class="intro">
      <p id="knowledge-text"></p>
    </div>
    <div id="info-link" class="hidden"></div>
    <button onclick="nextStar()" class="action-btn" >ç¹¼çºŒ</button>
  </div>
</div>

<!-- =========================================================
   çµå°¾é 
========================================================= -->
<div class="container">
  <div id="final-screen" class="hidden">
    <h1>ğŸŒŸ éŠæˆ²çµæŸï¼</h1>
    <h4>åœ¨é€™å ´æ©«è·¨å¤ªé™½ç³»çš„èˆªè¡Œä¸­ï¼Œ<br>ä½ é™è½éç‚™ç†±çš„è¡Œæ˜Ÿã€<br>ä¹Ÿè¸ä¸Šå†°å°è€Œé™é çš„ä¸–ç•Œï¼Œ<br>ä¸€æ¬¡æ¬¡è£œçµ¦ç‡ƒæ–™ã€‚<br>ä¸€æ¬¡æ¬¡æ‰¿å—å®‡å®™å¸¶ä¾†çš„è€ƒé©—ã€‚<br><br>åœ¨é€™å»£è¢¤ç„¡å çš„å®‡å®™ä¸­ï¼Œ<br>æ¯é¡†æ˜Ÿçƒéƒ½æœ‰å®ƒç¨ç‰¹çš„æ¨£è²Œï¼Œ</h4>
    <h2 id="final-highlight">é›–ç‚ºæ»„æµ·ä¸€ç²Ÿï¼Œ<br>å»æ–¼æ¸ºå°ä¸­ï¼Œèª•ç”Ÿæ„ç¾©ã€‚</h2>
    <div class="endscore-display" id="endscore-display"></div>
    <button onclick="restartWholeGame()" class="action-btn">é‡é—–å¤ªé™½ç³»</button>
  </div>
</div>

<script>
/* =========================================================
   æ¸¬è©¦ç”¨ï¼šå¼·åˆ¶å•†åº—ä¸€å®šåˆ·åˆ°æŸäº›å•†å“ + é–‹å ´ç‹€æ…‹
   - tools: æœƒè¢«å¡é€² shopToolsï¼ˆé“å…· 8 æ ¼ï¼‰
   - consumables: æœƒè¢«å¡é€² shopConsumablesï¼ˆæ¶ˆè€—å“ 2 æ ¼ï¼‰
   - levelIndex: æŒ‡å®šé—œå¡ï¼ˆ0=æ°´æ˜Ÿ, 1=é‡‘æ˜Ÿ...ï¼‰
   - startHP: æŒ‡å®šç•¶å‰è¡€é‡ï¼ˆæœƒè¢«å¤¾åœ¨ 0~maxHPï¼‰
   - initialHand: æŒ‡å®šç¬¬ä¸€è¼ªæ‰‹ç‰Œï¼ˆè£œçµ¦å¾Œç…§æ¨£æ­£å¸¸æŠ½ï¼‰
     - æ ¼å¼å¯ç”¨ ["SA","D2"] æˆ– [{suit:"S",rank:"A"}]
   - enabled=false æ™‚å®Œå…¨ä¸å½±éŸ¿æ­£å¸¸æŠ½æ¨£
========================================================= */
const TEST_FORCE_SHOP = {
  enabled: true, // è¦æ­£å¸¸æŠ½å°±æ”¹ false
  tools: [
    "åœ¨ã€æ¥µç«¯ä½æº«ã€‘æ˜Ÿçƒçš„é¦–æ¬¡è£œçµ¦ +15 ç‡ƒæ–™",
    "è‹¥æœ¬é—œæœªä½¿ç”¨æ£„ç‰Œï¼Œé€šé—œé‡‘å¹£ +30%",
    //"é †å­ç‰Œå‹æ¯å¼µç‰Œå¯ç›¸å·®1é»",
  ],
  consumables: [
    "ä¸‹ä¸€æ¬¡è£œçµ¦è‹¥ç‚ºé«˜ç‰Œ/ä¸€å°/å…©å°ï¼Œ +25 ç‡ƒæ–™",
    "æ‰£è¡€é »ç‡æ”¹ç‚º4æ¬¡è£œçµ¦ï¼ŒæŒçºŒä¸€é—œ",
  ],
  levelIndex: 5,

  startHP: null,
  initialHand: [
    { suit:'D', rank:'A'},
    { suit:'D', rank:'K'},
    { suit:'D', rank:'Q'},
    { suit:'D', rank:'J'},
    { suit:'D', rank:'T'},
    { suit:'S', rank:'A'},
    { suit:'D', rank:'9'},
    ],
};
function findToolByName(name){
  return TOOL_DATA.find(t => t.name === name) || null;
}
function findConsumableByName(name){
  return CONSUMABLE_DATA.find(c => c.name === name) || null;
}
function normalizeCardSpec(spec){
  if(!spec) return null;
  if(typeof spec === 'string'){
    const trimmed = spec.trim().toUpperCase();
    if(trimmed.length !== 2) return null;
    const suit = trimmed[0];
    const rank = trimmed[1];
    return { suit, rank };
  }
  if(typeof spec === 'object' && spec.suit && spec.rank){
    return { suit: String(spec.suit).toUpperCase(), rank: String(spec.rank).toUpperCase() };
  }
  return null;
}
function applyTestLevelOverride(){
  if(!TEST_FORCE_SHOP?.enabled) return;
  if(Number.isInteger(TEST_FORCE_SHOP.levelIndex)){
    const idx = Math.max(0, Math.min(LEVELS.length - 1, TEST_FORCE_SHOP.levelIndex));
    levelIndex = idx;
    return;
  }
}
function applyTestStartHp(){
  if(!TEST_FORCE_SHOP?.enabled) return;
  if(TEST_FORCE_SHOP.startHP == null) return;
  const value = Number(TEST_FORCE_SHOP.startHP);
  if(Number.isNaN(value)) return;
  hp = Math.min(maxHP, Math.max(0, value));
}
function applyTestInitialHand(){
  if(!TEST_FORCE_SHOP?.enabled) return false;
  if(!Array.isArray(TEST_FORCE_SHOP.initialHand) || TEST_FORCE_SHOP.initialHand.length === 0){
    return false;
  }
  hand = [];
  TEST_FORCE_SHOP.initialHand.forEach(spec=>{
    const cardSpec = normalizeCardSpec(spec);
    if(!cardSpec) return;
    const idx = drawPile.findIndex(c => c.suit === cardSpec.suit && c.rank === cardSpec.rank);
    if(idx < 0) return;
    hand.push(drawPile.splice(idx, 1)[0]);
  });
  return true;
}
function forceInjectShopOffers(){
  if(!TEST_FORCE_SHOP?.enabled) return;
  
  // ===== é“å…·ï¼šå¼·åˆ¶å¡é€² 8 æ ¼ =====
  if(Array.isArray(TEST_FORCE_SHOP.tools) && TEST_FORCE_SHOP.tools.length){
    TEST_FORCE_SHOP.tools.forEach(name=>{
      const def = findToolByName(name);
      if(!def) return;

      // å·²å”®ç½„å°±ä¸å¡ï¼ˆé¿å…æ¸¬è©¦æ™‚å¡ä½ï¼‰
      if(isToolSoldOut(def)) return;

      // å·²åœ¨è²¨æ¶ä¸Šå°±è·³é
      if(shopTools.some(t => t.name === def.name)) return;

      // å¡é€²å»ï¼šæ”¾æœ€å‰é¢
      shopTools.unshift(def);

      // è¶…é 8 æ ¼å°±ç æ‰æœ€å¾Œä¸€å€‹ï¼ˆé¿å…ç åˆ°å‰›å¡çš„ï¼‰
      if(shopTools.length > 8) shopTools.pop();
    });

    // ä»ç¢ºä¿å›ºå®šé“å…·åœ¨æœ€å¾Œ
    const nonFixedPart = shopTools.filter(t=>!t.fixed);
    const fixedPart = shopTools.filter(t=>t.fixed);
    shopTools = [...nonFixedPart, ...fixedPart].slice(0,8);
  }

  // ===== æ¶ˆè€—å“ï¼šå¼·åˆ¶å¡é€² 2 æ ¼ =====
  if(Array.isArray(TEST_FORCE_SHOP.consumables) && TEST_FORCE_SHOP.consumables.length){
    TEST_FORCE_SHOP.consumables.forEach(name=>{
      const def = findConsumableByName(name);
      if(!def) return;

      // å·²åœ¨è²¨æ¶ä¸Šå°±è·³é
      if(shopConsumables.some(c => c.name === def.name)) return;

      // å¡é€²å»ï¼šæ”¾æœ€å‰é¢
      shopConsumables.unshift(def);

      // è¶…é 2 æ ¼å°±ç æ‰æœ€å¾Œä¸€å€‹
      if(shopConsumables.length > 2) shopConsumables.pop();
    });
  }
}

/* =========================================================
   è¦æ ¼å¯èª¿å€
========================================================= */
let HAND_SIZE = 8;                 // å¯ç”±é“å…·å‡åˆ° 11
const HAND_SIZE_MAX = 11;
const MAX_SELECT = 5;

const CARD_IMAGE_PATH = 'https://raw.githubusercontent.com/BonBonChou/The_Great_Solar_System_Adventure/main/images/';

// æ¯é—œæ£„ç‰Œæ¬¡æ•¸ï¼ˆé è¨­ 3 æ¬¡ï¼‰
const DISCARD_PER_LEVEL = 3;

// å¤§é—œè£œçµ¦æ‰£ HP è¦å‰‡ï¼šæ¯ N æ¬¡è£œçµ¦æ‰£ 1 HP
const SUPPLY_PER_HP_BY_STAGE = { 1: 3, 2: 2, 3: 1 };

const FUEL_BY_HANDTYPE = {
  "é«˜ç‰Œ": 15,
  "ä¸€å°": 25,
  "å…©å°": 35,
  "ä¸‰æ¢": 45,
  "é †å­": 55,
  "åŒèŠ±": 60,
  "è‘«è˜†": 70,
  "éµæ”¯": 130,
  "åŒèŠ±é †": 220,
  "çš‡å®¶åŒèŠ±é †": 350
};
const HAND_TYPE_ORDER = [
  "é«˜ç‰Œ","ä¸€å°","å…©å°","ä¸‰æ¢","é †å­","åŒèŠ±","è‘«è˜†","éµæ”¯","åŒèŠ±é †","çš‡å®¶åŒèŠ±é †"
];

const PLANET_HANDTYPE_BONUS = {
  "å…©å°": ["è‰¾æ­", "æ­ç¾…å·´"],
  "ä¸‰æ¢": ["å†¥ç‹æ˜Ÿ"],
  "é †å­": ["æ°´æ˜Ÿ", "é‡‘æ˜Ÿ", "åœ°çƒ", "ç«æ˜Ÿ"],
  "åŒèŠ±": ["å¤©ç‹æ˜Ÿ", "æµ·ç‹æ˜Ÿ"],
  "è‘«è˜†": ["æœ¨æ˜Ÿ", "åœŸæ˜Ÿ"]
};

/* ===== é—œå¡è³‡æ–™ =====
   
=========================*/
const STAGE_INFO = {
  1: { baseMaxHP: 10 },
  2: { baseMaxHP: 8 },
  3: { baseMaxHP: 6 }
};

const LEVELS = [
  // ç¬¬ä¸€å¤§é—œ
  { stage:1, name:"æ°´æ˜Ÿ", targetFuel:60, passCoins:10, image:"https://raw.githubusercontent.com/BonBonChou/The_Great_Solar_System_Adventure/main/images/mercury.png", traits:["æ¥µç«¯æº«å·®","ç¨€è–„/ç¼ºä¹å¤§æ°£"] },
  { stage:1, name:"é‡‘æ˜Ÿ", targetFuel:70, passCoins:12, image:"https://raw.githubusercontent.com/BonBonChou/The_Great_Solar_System_Adventure/main/images/venus.png", traits:["é«˜å£“ç’°å¢ƒ","åœ°è³ªé«˜åº¦æ´»èº"] },
  { stage:1, name:"åœ°çƒ", targetFuel:80, passCoins:14, image:"https://raw.githubusercontent.com/BonBonChou/The_Great_Solar_System_Adventure/main/images/earth.png", traits:["åœ°è³ªé«˜åº¦æ´»èº","å¯èƒ½å­˜åœ¨ç”Ÿå‘½"] },
  { stage:1, name:"ç«æ˜Ÿ", targetFuel:90, passCoins:16, image:"https://raw.githubusercontent.com/BonBonChou/The_Great_Solar_System_Adventure/main/images/mars.png", traits:["æ¥µç«¯æº«å·®","ç¨€è–„/ç¼ºä¹å¤§æ°£"] },

  // ç¬¬äºŒå¤§é—œ
  { stage:2, name:"æœ¨æ˜Ÿ", targetFuel:140, passCoins:22, image:"https://raw.githubusercontent.com/BonBonChou/The_Great_Solar_System_Adventure/main/images/jupiter.png", traits:["é«˜å£“ç’°å¢ƒ","æ¥µç«¯æ°£å€™"] },
  { stage:2, name:"è‰¾æ­", targetFuel:160, passCoins:25, image:"https://raw.githubusercontent.com/BonBonChou/The_Great_Solar_System_Adventure/main/images/io.png", traits:["ç¨€è–„/ç¼ºä¹å¤§æ°£","åœ°è³ªé«˜åº¦æ´»èº","æ¥µç«¯ä½æº«"] },
  { stage:2, name:"æ­ç¾…å·´", targetFuel:175, passCoins:28, image:"https://raw.githubusercontent.com/BonBonChou/The_Great_Solar_System_Adventure/main/images/europa.png", traits:["ç¨€è–„/ç¼ºä¹å¤§æ°£","å¯èƒ½å­˜åœ¨ç”Ÿå‘½","æ¥µç«¯ä½æº«"] },
  { stage:2, name:"åœŸæ˜Ÿ", targetFuel:190, passCoins:32, image:"https://raw.githubusercontent.com/BonBonChou/The_Great_Solar_System_Adventure/main/images/saturn.png", traits:["é«˜å£“ç’°å¢ƒ"] },

  // ç¬¬ä¸‰å¤§é—œ
  { stage:3, name:"å¤©ç‹æ˜Ÿ", targetFuel:210, passCoins:45, image:"https://raw.githubusercontent.com/BonBonChou/The_Great_Solar_System_Adventure/main/images/uranus.png", traits:["æ¥µç«¯ä½æº«"] },
  { stage:3, name:"æµ·ç‹æ˜Ÿ", targetFuel:230, passCoins:50, image:"https://raw.githubusercontent.com/BonBonChou/The_Great_Solar_System_Adventure/main/images/neptune.png", traits:["æ¥µç«¯æ°£å€™","æ¥µç«¯ä½æº«"] },
  { stage:3, name:"å†¥ç‹æ˜Ÿ", targetFuel:250, passCoins:60, image:"https://raw.githubusercontent.com/BonBonChou/The_Great_Solar_System_Adventure/main/images/pluto.png", traits:["ç¨€è–„/ç¼ºä¹å¤§æ°£","åœ°è³ªé«˜åº¦æ´»èº","æ¥µç«¯ä½æº«"] },
];

// ç›®å‰é—œå¡
let levelIndex = 0; // 0=æ°´æ˜Ÿï¼Œ1=é‡‘æ˜Ÿ...

/* =========================================================
   DOM
========================================================= */
const toast = document.getElementById('toast');

const handCards = document.getElementById('hand-cards');
const btnPlay = document.getElementById('btn-play');
const btnDiscard = document.getElementById('btn-discard');

const hudStageText = document.getElementById('hud-stage-text');
const hudFuel = document.getElementById('hud-fuel');
const hudDeck = document.getElementById('hud-deck');
const hudTarget = document.getElementById('hud-target');
const hudDiscards = document.getElementById('hud-discards');
const hpFill = document.getElementById('hp-fill');
const hpText = document.getElementById('hp-text');
const levelNameEl = document.getElementById('level-name');
const planetImageEl = document.getElementById('planet-image');


/* =========================================================
   ç‰Œåº«å®šç¾©ï¼ˆ52 å¼µï¼‰
========================================================= */
const SUITS = ['S','H','D','C'];
const RANKS = ['2','3','4','5','6','7','8','9','T','J','Q','K','A'];
let deck = [];

SUITS.forEach(suit=>{
  RANKS.forEach(rank=>{
    deck.push({
      suit: suit,
      rank: rank,
      img: `${suit}${rank}.png`
    });
  });
});

/* =========================================================
   éŠæˆ²ç‹€æ…‹
========================================================= */
let bigStage = 1;          // å¤§é—œï¼š1~3
let hp = 3;
let maxHP = 0;
let fuel = 0;
let coins = 10; // åˆå§‹é‡‘å¹£
let targetFuel = 0;
let discardsLeft = DISCARD_PER_LEVEL;
let extraDiscards = 0;
let levelExtraDiscards = 0;
let supplyCountInStage = 0;  // æœ¬é—œè£œçµ¦æ¬¡æ•¸ç´¯ç©ï¼Œç”¨ä¾†æ‰£ HP

let drawPile = [];  // å¯æŠ½ç‰Œåº«ï¼ˆæœƒè®Šï¼‰
let hand = [];      // æ‰‹ç‰Œï¼ˆæœƒè®Šï¼‰
let played = [];    // å·²å‡ºç‰Œï¼ˆä¸å›ç‰Œåº«ï¼‰
let supplyBonusPerClear = 0; // æ°¸ä¹…æˆé•·ï¼šé€šé—œç´¯ç©çš„è£œçµ¦åŠ æˆ
let bigStageClearCount = 0;  // å·²é€šéçš„å¤§é—œæ•¸ï¼ˆå¯ç´¯ç©ï¼‰

function computeMaxHP(){
  // åŸºç¤è¡€é‡å–æ±ºæ–¼å¤§é—œï¼ˆ10/8/6ï¼‰
  const base = STAGE_INFO[bigStage]?.baseMaxHP ?? 10;

  const maxHpToolCount = ownedTools.get("æœ€å¤§ HP +1")?.count ?? 0;
  const perStageToolCount = ownedTools.get("æ¯é€šéä¸€å¤§é—œï¼Œæœ€å¤§ HP +1")?.count ?? 0;
  const bonus = maxHpToolCount + (bigStageClearCount * perStageToolCount);

  return base + bonus;
}

// ===== æœ¬é—œå…§ç‹€æ…‹ï¼ˆä¸å­˜æª”ï¼‰=====
let supplyCountInLevel = 0;          // æœ¬é—œç¬¬å¹¾æ¬¡è£œçµ¦
let usedHandTypesInLevel = new Set();// æœ¬é—œå·²ç”¨éçš„ç‰Œå‹
let immuneHitUsedInLevel = false;    // æ˜¯å¦å·²ç”¨æ‰ã€Œå…ç–«ç¬¬ä¸€æ¬¡å‚·å®³ã€
let freeDiscardUsedInLevel = false;  // æ˜¯å¦ç”¨æ‰ã€Œé¦–æ¬¡æ£„ç‰Œä¸æ¶ˆè€—æ¬¡æ•¸ã€
let straightPlusSupplyUsedInLevel = false; // æ˜¯å¦å·²ç”¨æ‰ã€Œé †å­ä»¥ä¸Šé¦–æ¬¡è£œçµ¦å›å¾©ã€

function resetLevelState(){
  supplyCountInLevel = 0;
  levelExtraDiscards = 0;
  usedHandTypesInLevel.clear();
  immuneHitUsedInLevel = false;
  straightPlusSupplyUsedInLevel = false;
  freeDiscardUsedInLevel = false;
  tempEffects = {
    nextSupplyNoRemove: false,            // æ¶ˆè€—å“ï¼šä¸‹ä¸€æ¬¡è£œçµ¦ç”¨çš„ç‰Œå…¨éƒ¨ä¸ç§»é™¤ï¼ˆä¸€æ¬¡æ€§ï¼‰
    nextSupplyHandRankPlus1: 0,           // æ¶ˆè€—å“ï¼šä¸‹ä¸€æ¬¡ç‰Œå‹ç­‰ç´š +1ï¼ˆä¸€æ¬¡æ€§ï¼‰

    nextSupplyFuelPctFromDiscard: 0,      // é“å…·ï¼šæ¯æ£„1å¼µç‰Œï¼Œä¸‹æ¬¡è£œçµ¦ +5%ï¼ˆç´¯ç©åˆ°ä¸‹ä¸€æ¬¡è£œçµ¦å¾Œæ¸…ç©ºï¼‰
    nextSupplyFuelMult: 1,                // é“å…·ï¼šé«˜ç‰Œçš„ä¸‹æ¬¡è£œçµ¦ +50%ï¼ˆä¸€æ¬¡æ€§å€ç‡ï¼‰

    nextSupplyLowHandBonus: 0,            // æ¶ˆè€—å“ï¼šä¸‹ä¸€æ¬¡è‹¥ç‚º é«˜ç‰Œ/ä¸€å°/å…©å°ï¼Œ+25 ç‡ƒæ–™ï¼ˆä¸€æ¬¡æ€§ï¼‰
    supplyHpOverride: null,
  };

  // æ¯é—œé‡ç½®æ£„ç‰Œæ¬¡æ•¸ï¼ˆåªä¿ç•™æ°¸ä¹…åŠ æˆï¼‰
  discardsLeft = DISCARD_PER_LEVEL + extraDiscards;
}

function healHp(amount){
  if(amount <= 0){
    return;
  }
  if(hp >= maxHP){
    return;
  }
  hp = Math.min(maxHP, hp + amount);
}

// æ¶ˆè€—å“ / æš«æ™‚æ•ˆæœ
let tempEffects = {
  nextSupplyNoRemove: false,            // æ¶ˆè€—å“ï¼šä¸‹ä¸€æ¬¡è£œçµ¦ç”¨çš„ç‰Œå…¨éƒ¨ä¸ç§»é™¤ï¼ˆä¸€æ¬¡æ€§ï¼‰
  nextSupplyHandRankPlus1: 0,           // æ¶ˆè€—å“ï¼šä¸‹ä¸€æ¬¡ç‰Œå‹ç­‰ç´š +1ï¼ˆä¸€æ¬¡æ€§ï¼‰

  nextSupplyFuelPctFromDiscard: 0,      // é“å…·ï¼šæ¯æ£„1å¼µç‰Œï¼Œä¸‹æ¬¡è£œçµ¦ +5%ï¼ˆç´¯ç©åˆ°ä¸‹ä¸€æ¬¡è£œçµ¦å¾Œæ¸…ç©ºï¼‰
  nextSupplyFuelMult: 1,                // é“å…·ï¼šé«˜ç‰Œçš„ä¸‹æ¬¡è£œçµ¦ +50%ï¼ˆä¸€æ¬¡æ€§å€ç‡ï¼‰

  nextSupplyLowHandBonus: 0,            // æ¶ˆè€—å“ï¼šä¸‹ä¸€æ¬¡è‹¥ç‚º é«˜ç‰Œ/ä¸€å°/å…©å°ï¼Œ+25 ç‡ƒæ–™ï¼ˆä¸€æ¬¡æ€§ï¼‰
  supplyHpOverride: null,               // ä¾‹å¦‚ { per:4 }ï¼šæœ¬é—œæ‰£è¡€é »ç‡æ”¹ 4
};


/* =========================================================
   æ’åºï¼ˆé»æ•¸å„ªå…ˆï¼ŒèŠ±è‰² Sâ†’Hâ†’Dâ†’Cï¼‰
========================================================= */
const RANK_ORDER = ['2','3','4','5','6','7','8','9','T','J','Q','K','A'];
const SUIT_ORDER = ['S','H','D','C'];

function sortHand(arr){
  arr.sort((a,b)=>{
    const ra = RANK_ORDER.indexOf(a.rank);
    const rb = RANK_ORDER.indexOf(b.rank);
    if(ra !== rb) return ra - rb;

    const sa = SUIT_ORDER.indexOf(a.suit);
    const sb = SUIT_ORDER.indexOf(b.suit);
    return sa - sb;
  });
  return arr;
}

/* =========================================================
   å•†åº— UIï¼ˆå…ˆåšç•«é¢ï¼Œä¸åšè³¼è²·é‚è¼¯ï¼‰ 
========================================================= */
const shopOverlay = document.getElementById('shop-overlay');
const shopClose = document.getElementById('shop-close');
const shopTabs = [...document.querySelectorAll('.tab')];
const tabPages = [...document.querySelectorAll('.tab-page')];

const shopSubtabs = [...document.querySelectorAll('.subtab')];
const ownedToolsPage = document.getElementById('owned-tools');
const ownedConsumablesPage = document.getElementById('owned-consumables');

const toolsGrid = document.getElementById('tools-grid');
const consumablesGrid = document.getElementById('consumables-grid');
const ownedToolsGrid = document.getElementById('owned-tools-grid');
const ownedConsumablesGrid = document.getElementById('owned-consumables-grid');

let isShopOpen = false;

function setGamePaused(paused){
  // æš«åœï¼šå‡ºç‰Œ/æ£„ç‰Œä¸èƒ½æŒ‰ + ç‰Œä¸èƒ½é»
  if(paused){
    btnPlay.disabled = true;
    btnDiscard.disabled = true;
    handCards.style.pointerEvents = 'none';
  }else{
    handCards.style.pointerEvents = 'auto';
    updateActionButtons(); // ä¾ç›®å‰é¸ç‰Œ/æ£„ç‰Œæ¬¡æ•¸ç­‰ç‹€æ…‹æ¢å¾©
  }
}

function openShop(){
  isShopOpen = true;
  shopOverlay.classList.add('show');
  setGamePaused(true);
  ensureShopOffers();
}

function closeShop(){
  isShopOpen = false;
  shopOverlay.classList.remove('show');
  setGamePaused(false);
}

/* é»èƒŒæ™¯ä¸é—œï¼ˆé¿å…èª¤è§¸ï¼‰ï¼Œåªé» X é—œ */
shopClose.addEventListener('click', closeShop);

/* ESC é—œé–‰ï¼ˆæ¡Œæ©Ÿæ–¹ä¾¿ï¼Œæ‰‹æ©Ÿä¸å½±éŸ¿ï¼‰ */
window.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape' && isShopOpen) closeShop();
});

/* ç¬¬ä¸€å±¤åˆ†é åˆ‡æ› */
shopTabs.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    shopTabs.forEach(t=>t.classList.remove('active'));
    btn.classList.add('active');

    const targetId = btn.dataset.tab;
    tabPages.forEach(p=>{
      p.style.display = (p.id === targetId) ? '' : 'none';
    });
  });
});

/* ç¬¬äºŒå±¤åˆ†é ï¼ˆå·²æ“æœ‰ï¼‰åˆ‡æ› */
shopSubtabs.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    shopSubtabs.forEach(t=>t.classList.remove('active'));
    btn.classList.add('active');

    const target = btn.dataset.subtab;
    if(target === 'owned-tools'){
      ownedToolsPage.style.display = '';
      ownedConsumablesPage.style.display = 'none';
    }else{
      ownedToolsPage.style.display = 'none';
      ownedConsumablesPage.style.display = '';
    }
  });
});

/* ===== å…ˆå¡ã€Œå‡å•†å“ã€ä¾†ç¢ºèª UI ===== */
function renderItemCard(parent, item){
  const div = document.createElement('div');
  div.className = 'item-card';
  div.innerHTML = `
    <div class="item-name">${item.name}</div>
    <div class="item-desc">${item.desc}</div>
    <div class="item-meta">${item.meta}</div>
  `;
  parent.appendChild(div);
}

/* ===== å•†åº—è³‡æ–™ ===== */
const shopCoinEl = document.getElementById('shop-coin');

/* é“å…·æ¸…å–® */
const TOOL_DATA = [
  { name:"äººé ­ç‰Œ +5 ç‡ƒæ–™", price:[18], max:1 },
  { name:"æ¯é—œé¦–æ¬¡è£œçµ¦ +30% ç‡ƒæ–™", price:[28], max:1 },
  { name:"ä¸€é—œå…§æ¯æ¬¡è£œçµ¦ï¼Œé¡å¤– +3 ç‡ƒæ–™", price:[22], max:1 },
  { name:"è£œçµ¦ +20 ç‡ƒæ–™ï¼Œæ¯æ¬¡é€šé—œå¾Œå†æ°¸ä¹… +2 ç‡ƒæ–™", price:[40], max:1, sellable:false },
  { name:"æ¯æ£„1å¼µç‰Œï¼Œä¸‹æ¬¡è£œçµ¦ç²å¾—ç‡ƒæ–™ +5%", price:[26], max:1 },
  { name:"è‹¥è£œçµ¦åªå«äººé ­ç‰Œï¼Œ+20% ç‡ƒæ–™", price:[24], max:1 },
  { name:"é«˜ç‰Œçš„ä¸‹æ¬¡è£œçµ¦ +50% ç‡ƒæ–™", price:[20], max:1 },
  { name:"è‹¥è£œçµ¦åŒ…å«3å¼µç‰Œä»¥ä¸Šï¼Œ+20% ç‡ƒæ–™", price:[18], max:1 },
  { name:"ç›®å‰ç‰Œçµ„æ¯å°‘1å¼µç‰Œ +2 ç‡ƒæ–™", price:[18], max:1 },
  { name:"ä¸€é—œå…§æ¯ä½¿ç”¨éä¸€ç¨®ç‰Œå‹ +6 ç‡ƒæ–™", price:[26], max:1 },
  { name:"è£œçµ¦å°‡ä¸æœƒç§»é™¤äººé ­ç‰Œ", price:[45], max:1 },

  // å¯å¤šæ¬¡è³¼è²·ï¼ˆæœ€å¤š 2 æ¬¡ï¼‰
  { name:"å¢åŠ 1æ£„ç‰Œæ¬¡æ•¸", price:[24,34], max:2, sellable:false },

  // å¯å¤šæ¬¡è³¼è²·ï¼ˆæœ€å¤š 3 æ¬¡ï¼‰
  { name:"æ‰‹ç‰Œä¸Šé™+1å¼µ", price:[28,38,48], max:3, sellable:false },

  { name:"é»‘æ¡ƒå’Œæ¢…èŠ±è¦–ç‚ºåŒèŠ±è‰²", price:[32], max:1 },
  { name:"ç´…å¿ƒå’Œæ–¹å¡Šè¦–ç‚ºåŒèŠ±è‰²", price:[32], max:1 },
  { name:"åƒ…éœ€4å¼µç‰Œå³å¯æ§‹ç¯‰é †å­ã€åŒèŠ±", price:[48], max:1 },
  { name:"é †å­ç‰Œå‹æ¯å¼µç‰Œå¯ç›¸å·®1é»", price:[44], max:1 },
  { name:"è‹¥è£œçµ¦åŒ…å«5å¼µç‰Œï¼Œç•¶å±€ç²å¾—1æ¬¡æ£„ç‰Œæ¬¡æ•¸", price:[34], max:1 },
  { name:"æ¯é—œé¦–æ¬¡è£œçµ¦å›å¾© 1 HP", price:[24], max:1 },
  { name:"é€šé—œæ™‚è‹¥ HP â‰¤ 2ï¼Œå›å¾©è‡³ 3", price:[20], max:1 },
  { name:"æ¯é—œæ¯ä½¿ç”¨ä¸€ç¨®æ–°ç‰Œå‹ï¼Œå›å¾© 1 HP", price:[36], max:1 },
  { name:"æ¯é—œé¦–æ¬¡è£œçµ¦é †å­ä»¥ä¸Šç‰Œå‹ï¼Œå›å¾© 1 HP", price:[22], max:1 },
  { name:"æœ€å¤§ HP +1", price:[15,18,21,24], max:4, sellable:false },
  { name:"æ¯é€šéä¸€å¤§é—œï¼Œæœ€å¤§ HP +1", price:[30], max:1 },
  { name:"æ¯é—œå…ç–«ç¬¬ä¸€æ¬¡å‚·å®³", price:[28], max:1 },

  { name:"åœ¨ã€æ¥µç«¯æº«å·®ã€‘æ˜Ÿçƒè£œçµ¦ +15% ç‡ƒæ–™", price:[18], max:1 },
  { name:"åœ¨ã€ç¨€è–„/ç¼ºä¹å¤§æ°£ã€‘æ˜Ÿçƒï¼Œæ¯æ¬¡è£œçµ¦ç§»é™¤çš„ç‰Œéš¨æ©Ÿå°‘ 1 å¼µ", price:[20], max:1 },
  { name:"åœ¨ã€é«˜å£“ç’°å¢ƒã€‘æ˜Ÿçƒè£œçµ¦ +10 ç‡ƒæ–™", price:[16], max:1 },
  { name:"åœ¨ã€æ¥µç«¯æ°£å€™ã€‘æ˜Ÿçƒçš„é¦–æ¬¡è£œçµ¦ +20% ç‡ƒæ–™", price:[16], max:1 },
  { name:"åœ¨ã€åœ°è³ªé«˜åº¦æ´»èºã€‘æ˜Ÿçƒçš„è£œçµ¦åŒ…å« 3 å¼µæˆ–ä»¥ä¸‹æ™‚ï¼Œç‡ƒæ–™ +25%", price:[18], max:1 },
  { name:"åœ¨ã€å¯èƒ½å­˜åœ¨ç”Ÿå‘½ã€‘æ˜Ÿçƒçš„é¦–æ¬¡æ£„ç‰Œä¸æ¶ˆè€—æ¬¡æ•¸", price:[18], max:1 },
  { name:"åœ¨ã€æ¥µç«¯ä½æº«ã€‘æ˜Ÿçƒçš„é¦–æ¬¡è£œçµ¦ +15 ç‡ƒæ–™", price:[18], max:1 },

  // å›ºå®šé“å…·ï¼ˆæ°¸é åœ¨å•†åº—ï¼Œæ”¾æœ€å¾Œï¼‰
  { name:"é€šé—œé‡‘å¹£ +10%", price:[16], max:1, fixed:true },
  { name:"è‹¥æœ¬é—œæœªä½¿ç”¨æ£„ç‰Œï¼Œé€šé—œé‡‘å¹£ +30%", price:[20], max:1, fixed:true }
];

const CONSUMABLE_DATA = [
  { name:"æ‰£è¡€é »ç‡æ”¹ç‚º4æ¬¡è£œçµ¦ï¼ŒæŒçºŒä¸€é—œ", price:18, sellable:false },
  { name:"ç«‹å³å›å¾© 2 HP", price:14, sellable:false },
  { name:"åœ¨ã€æ¥µç«¯ä½æº«ã€‘æ˜Ÿçƒçš„ä¸‹ä¸€æ¬¡è£œçµ¦ +30% ç‡ƒæ–™", price:12 },
  { name:"ä¸‹ä¸€æ¬¡è£œçµ¦ä½¿ç”¨çš„ç‰Œå…¨éƒ¨ä¸ç§»é™¤", price:16 },
  { name:"ä¸‹ä¸€æ¬¡è£œçµ¦çš„ç‰Œå‹ç­‰ç´š +1", price:18 },
  { name:"ä¸‹ä¸€æ¬¡è£œçµ¦è‹¥ç‚ºé«˜ç‰Œ/ä¸€å°/å…©å°ï¼Œ +25 ç‡ƒæ–™", price:16 },
  { name:"ç«‹å³å¾ç‰Œåº«ä¸­æŠ½ 2 å¼µã€é¸ 1 å¼µåŠ å…¥æ‰‹ç‰Œï¼Œå¦ä¸€å¼µæ£„å›ç‰Œåº«", price:14, sellable:false }
];

/* å·²æ“æœ‰ */
const ownedTools = new Map();        // key: name, value: count
const ownedConsumables = new Map();  // key: name, value: count

/* å•†åº—ç•¶å‰è²¨æ¶ */
let shopTools = [];       // 8 æ ¼ï¼ˆå«å›ºå®šï¼‰
let shopConsumables = []; // 2 æ ¼

function updateShopCoin(){
  shopCoinEl.textContent = coins;
}

/* éš¨æ©ŸæŠ½æ¨£å·¥å…· */
function pickRandom(list, k){
  const arr = [...list];
  shuffle(arr);
  return arr.slice(0, Math.min(k, arr.length));
}

function getToolBuyCount(name){
  const obj = ownedTools.get(name);
  return obj ? obj.count : 0;
}

function getToolCurrentPrice(tool){
  const bought = getToolBuyCount(tool.name);
  return tool.price[Math.min(bought, tool.price.length - 1)];
}

function isToolSoldOut(tool){
  const bought = getToolBuyCount(tool.name);
  return bought >= tool.max;
}


function ownedGet(map, name){
  return map.get(name) || { count:0, paid:[] };
}

function ownedAdd(map, name, paidPrice){
  const obj = ownedGet(map, name);
  obj.count += 1;
  obj.paid.push(paidPrice);
  map.set(name, obj);
}

function ownedRemoveOne(map, name){
  const obj = ownedGet(map, name);
  if(obj.count <= 0) return null;

  obj.count -= 1;
  const lastPaid = obj.paid.pop(); // ä»¥ã€Œæœ€å¾Œè²·å…¥ã€ä½œç‚ºæœ¬æ¬¡å”®å‡ºçš„æˆæœ¬
  if(obj.count <= 0){
    map.delete(name);
  }else{
    map.set(name, obj);
  }
  return lastPaid; // å›å‚³é€™æ¬¡å”®å‡ºçš„è²·å…¥åƒ¹
}

function hasConsumable(name){
  const obj = ownedConsumables.get(name);
  return !!obj && obj.count > 0;
}

// âœ… æ¶ˆè€—å“ç”Ÿæ•ˆæ™‚æ‰ã€Œæ‰£æ‰ 1 å€‹ã€ï¼šä¸çµ¦éŒ¢ã€ä¸èµ°å‡ºå”®æµç¨‹
function consumeConsumable(name){
  // ownedRemoveOne æœƒæŠŠ count -1 ä¸¦å›å‚³ paidï¼›é€™è£¡æˆ‘å€‘å¿½ç•¥ paid
  return ownedRemoveOne(ownedConsumables, name) != null;
}

function sellPriceFromPaid(paidPrice){
  return Math.floor(paidPrice / 2);
}


/* ç”Ÿæˆå•†åº—è²¨æ¶ï¼š6 éš¨æ©Ÿ + 2 å›ºå®šï¼ˆå›ºå®šæ”¾æœ€å¾Œï¼‰
   è‹¥å›ºå®šå·²è²·å®Œï¼ˆå”®ç½„ï¼‰â†’ ç”¨éš¨æ©Ÿè£œæ»¿åˆ° 8 æ ¼
*/
function generateShopOffers(){
  const fixedTools = TOOL_DATA.filter(t=>t.fixed);
  const nonFixedTools = TOOL_DATA.filter(t=>!t.fixed);

  const nonFixedAvailable = nonFixedTools.filter(t=>!isToolSoldOut(t));
  const fixedAvailable = fixedTools.filter(t=>!isToolSoldOut(t));

  // å…ˆæŠ½ 6 å€‹éš¨æ©Ÿï¼ˆå¾éå›ºå®šä¸”å¯è²·çš„è£¡é¢ï¼‰
  const pickedNonFixed = pickRandom(nonFixedAvailable, 6);

  // å›ºå®šæ”¾æœ€å¾Œï¼ˆä½†å¦‚æœå›ºå®šå”®ç½„å°±ä¸æ”¾ï¼‰
  let result = [...pickedNonFixed, ...fixedAvailable];

  // è‹¥ä¸è¶³ 8 æ ¼ï¼Œå¾å‰©ä¸‹çš„ nonFixedAvailable è£œï¼ˆé¿å…é‡è¤‡ï¼‰
  const usedNames = new Set(result.map(x=>x.name));
  const rest = nonFixedAvailable.filter(t=>!usedNames.has(t.name));
  while(result.length < 8 && rest.length > 0){
    const one = pickRandom(rest, 1)[0];
    result.push(one);
    usedNames.add(one.name);
    const idx = rest.findIndex(t=>t.name===one.name);
    if(idx !== -1) rest.splice(idx, 1);
  }

  // æœ€å¾Œç¢ºä¿ã€Œå›ºå®šé“å…·æ’åœ¨æœ«ç«¯ã€
  const nonFixedPart = result.filter(t=>!t.fixed);
  const fixedPart = result.filter(t=>t.fixed);
  shopTools = [...nonFixedPart, ...fixedPart].slice(0,8);

  // æ¶ˆè€—å“ï¼šæŠ½ 2 å€‹
  shopConsumables = pickRandom(CONSUMABLE_DATA, 2);

  // æ¸¬è©¦ç”¨å¼·åˆ¶å¡æŒ‡å®šå•†å“
  forceInjectShopOffers();
}

/* ===== æ¸²æŸ“å¡ç‰‡ï¼ˆå«è³¼è²·æŒ‰éˆ•ï¼‰ ===== */
function renderShop(){
  updateShopCoin();

  // é“å…·
  toolsGrid.innerHTML = '';
  shopTools.forEach(tool=>{
    const bought = getToolBuyCount(tool.name);
    const price = getToolCurrentPrice(tool);
    const soldOut = isToolSoldOut(tool);

    const div = document.createElement('div');
    div.className = 'item-card';
    const unsellableText = (tool.sellable === false)
      ? `<span class="item-unsellable">ç„¡æ³•å”®å‡º</span>`
      : '';

    div.innerHTML = `
      <div class="item-name">${tool.name}</div>

      <div class="item-meta" style="display:flex; align-items:center; gap:8px;">
        <span>åƒ¹æ ¼ï¼š${price}</span>
        ${unsellableText}
      </div>

      <button class="action-btn" style="margin-top:8px;" ${soldOut ? 'disabled' : ''}>
        è³¼è²·
      </button>
    `;

    const btn = div.querySelector('button');
    btn.addEventListener('click', ()=>{
      buyTool(tool);
    });

    toolsGrid.appendChild(div);
  });

  // æ¶ˆè€—å“
  consumablesGrid.innerHTML = '';
  shopConsumables.forEach(item=>{
    const div = document.createElement('div');
    div.className = 'item-card';
    const unsellableText = (item.sellable === false)
      ? `<span class="item-unsellable">ç„¡æ³•å”®å‡º</span>`
      : '';

    div.innerHTML = `
      <div class="item-name">${item.name}</div>

      <div class="item-meta" style="display:flex; align-items:center; gap:8px;">
        <span>åƒ¹æ ¼ï¼š${item.price}</span>
        ${unsellableText}
      </div>

      <button class="action-btn" style="margin-top:8px;">
        è³¼è²·
      </button>
    `;

    const btn = div.querySelector('button');
    btn.addEventListener('click', ()=>{
      buyConsumable(item);
    });

    consumablesGrid.appendChild(div);
  });

  // å·²æ“æœ‰ï¼šé“å…·
  ownedToolsGrid.innerHTML = '';
  if(ownedTools.size === 0){
    ownedToolsGrid.innerHTML = `<div class="item-card"><div class="item-name">ï¼ˆå°šæœªæ“æœ‰é“å…·ï¼‰</div></div>`;
  }else{
    [...ownedTools.entries()].forEach(([name,obj])=>{
      const div = document.createElement('div');
      div.className = 'item-card';
      const sellable = isSellableOwned('tool', name);
      const lastPaid = obj.paid[obj.paid.length - 1] ?? 0;
      const sellPrice = sellable ? sellPriceFromPaid(lastPaid) : null;

      div.innerHTML = `
        <div class="item-name">${name}</div>

        <div class="item-meta" style="display:flex; align-items:center; gap:12px;">
          <span>æ•¸é‡ï¼š${obj.count}</span>

          ${
            sellable
              ? `<span>å‡ºå”®åƒ¹æ ¼ï¼š${sellPrice}</span>`
              : `<span class="item-unsellable" style="margin-left:auto;">ç„¡æ³•å‡ºå”®</span>`
          }
        </div>
      `;

      if(sellable){
        div.style.cursor = 'pointer';
        div.addEventListener('click', ()=> openSellConfirm('tool', name));
      }else{
        div.style.cursor = 'not-allowed';
        div.style.opacity = '0.85';
        div.addEventListener('click', ()=> showToastText('æ­¤ç‰©å“ä¸å¯å‡ºå”®', 900));
      }
      ownedToolsGrid.appendChild(div);
    });
  }

  // å·²æ“æœ‰ï¼šæ¶ˆè€—å“
  ownedConsumablesGrid.innerHTML = '';
  if(ownedConsumables.size === 0){
    ownedConsumablesGrid.innerHTML = `<div class="item-card"><div class="item-name">ï¼ˆå°šæœªæ“æœ‰æ¶ˆè€—å“ï¼‰</div></div>`;
  }else{
    [...ownedConsumables.entries()].forEach(([name,obj])=>{
      const sellable = isSellableOwned('consumable', name);
      const lastPaid = obj.paid[obj.paid.length - 1] ?? 0;
      const sellPrice = sellable ? sellPriceFromPaid(lastPaid) : null;

      const div = document.createElement('div');
      div.className = 'item-card';

      div.innerHTML = `
        <div class="item-name">${name}</div>

        <div class="item-meta" style="display:flex; align-items:center; gap:12px;">
          <span>æ•¸é‡ï¼š${obj.count}</span>

          ${
            sellable
              ? `<span>å‡ºå”®åƒ¹æ ¼ï¼š${sellPrice}</span>`
              : `<span class="item-unsellable" style="margin-left:auto;">ç„¡æ³•å‡ºå”®</span>`
          }
        </div>
      `;

      if(sellable){
        div.style.cursor = 'pointer';
        div.addEventListener('click', ()=> openSellConfirm('consumable', name));
      }else{
        div.style.cursor = 'not-allowed';
        div.style.opacity = '0.85';
        div.addEventListener('click', ()=> showToastText('æ­¤ç‰©å“ä¸å¯å‡ºå”®', 900));
      }
      ownedConsumablesGrid.appendChild(div);
    });
  }
}

/* ===== å‡ºå”®ç¢ºèªé‚è¼¯ ===== */
const confirmOverlay = document.getElementById('confirm-overlay');
const confirmText = document.getElementById('confirm-text');
const confirmYes = document.getElementById('confirm-yes');
const confirmNo = document.getElementById('confirm-no');

let pendingSell = null; // { type:'tool'|'consumable', name:string }

function openSellConfirm(type, name){
  if(!isSellableOwned(type, name)){
    showToastText('æ­¤ç‰©å“ä¸å¯å‡ºå”®', 900);
    return;
  }
  pendingSell = { type, name };
  confirmText.textContent = `æ˜¯å¦å‡ºå”®ã€Œ${name}ã€ï¼Ÿ`;
  confirmOverlay.style.display = 'flex';
}


function closeSellConfirm(){
  pendingSell = null;
  confirmOverlay.style.display = 'none';
}

confirmNo.addEventListener('click', closeSellConfirm);

confirmYes.addEventListener('click', ()=>{
  if(!pendingSell) return;

  const { type, name } = pendingSell;

  let paid = null;
  if(type === 'tool'){
    paid = ownedRemoveOne(ownedTools, name);
  }else{
    paid = ownedRemoveOne(ownedConsumables, name);
  }

  if(paid == null){
    closeSellConfirm();
    renderShop();
    return;
  }

  const gain = sellPriceFromPaid(paid);
  coins += gain;

  // âœ… è³£æ‰å¾Œï¼šå•†åº—ä¹‹å¾Œæœ‰æ©Ÿæœƒåˆ·åˆ°
  // é€™è£¡ä¸ç”¨ç«‹åˆ»æŠŠå®ƒå¡å›æœ¬é—œè²¨æ¶ï¼ˆé¿å…é•åã€Œæœ¬é—œä¸åˆ·æ–°ã€ï¼‰
  // åªè¦å®ƒä¸å†è¢«è¦–ç‚º sold outï¼Œä¸‹æ¬¡é€šé—œåˆ·æ–°å°±æœƒæœ‰æ©Ÿæœƒå‡ºç¾

  showToastText(`å‡ºå”®æˆåŠŸ +${gain} é‡‘å¹£`, 900);

  closeSellConfirm();
  renderShop();
  saveProgress();
});


/* ===== è³¼è²·è¡Œç‚ºï¼ˆå…ˆåšå…¥åº« + å¾å•†åº—æ¶ˆå¤±/è®Šåƒ¹ï¼‰ ===== */
function buyTool(tool){
  const price = getToolCurrentPrice(tool);
  if(coins < price){
    showToastText('é‡‘å¹£ä¸è¶³', 900);
    return;
  }

  coins -= price;

  ownedAdd(ownedTools, tool.name, price);

  if(tool.name === "å¢åŠ 1æ£„ç‰Œæ¬¡æ•¸"){
    extraDiscards += 1;
    discardsLeft += 1;
    updateHUD();
  }else if(tool.name === "æ‰‹ç‰Œä¸Šé™+1å¼µ"){
    HAND_SIZE = Math.min(HAND_SIZE + 1, HAND_SIZE_MAX);
    const targetHandSize = Math.min(HAND_SIZE, HAND_SIZE_MAX);
    const drawCount = Math.max(0, targetHandSize - hand.length);
    if(drawCount > 0){
      drawFromPile(drawCount);
    }
    renderHand();
    updateHUD();
  }else if(tool.name === "æœ€å¤§ HP +1"){
    maxHP = computeMaxHP();
    hp = Math.min(maxHP, hp + 1);
    updateHUD();
  }

  // âœ… è‹¥é”ä¸Šé™ï¼šå¾æœ¬é—œå•†åº—è²¨æ¶ç§»é™¤ï¼ˆä¸è£œè²¨ã€ä¸åˆ·æ–°ï¼‰
  if(isToolSoldOut(tool)){
    shopTools = shopTools.filter(t=>t.name !== tool.name);
  }

  showToastText('è³¼è²·æˆåŠŸ', 700);
  renderShop();
  saveProgress();
}


function buyConsumable(item){
  if(coins < item.price){
    showToastText('é‡‘å¹£ä¸è¶³', 900);
    return;
  }
  coins -= item.price;

  // âœ… åªæœ‰é€™å…©å€‹ï¼šè²·äº†ç«‹åˆ»ç”Ÿæ•ˆï¼ˆä¸”æœ¬ä¾†å°±ä¸å¯å”®å‡ºï¼‰
  if(item.name === "ç«‹å³å›å¾© 2 HP"){
    healHp(2);
    updateHUD();
    showToastText('å›å¾© +2 HP', 900);

  }else if(item.name === "ç«‹å³å¾ç‰Œåº«ä¸­æŠ½ 2 å¼µã€é¸ 1 å¼µåŠ å…¥æ‰‹ç‰Œï¼Œå¦ä¸€å¼µæ£„å›ç‰Œåº«"){
    showToastText('è«‹å¾å…©å¼µç‰Œä¸­é¸ä¸€å¼µ', 900);
    useConsumable_Draw2Pick1();

  }else{
    // âœ… å…¶ä»–å…¨éƒ¨ï¼šåªå…¥åº«ï¼ˆæ˜¯å¦ç”Ÿæ•ˆç”± owned åˆ¤æ–·ï¼‰
    ownedAdd(ownedConsumables, item.name, item.price);
    showToastText('è³¼è²·æˆåŠŸ', 700);
  }

  // âœ… è²·äº†å°±å¾ç•¶å‰è²¨æ¶æ¶ˆå¤±ï¼ˆæœ¬é—œä¸è£œè²¨ï¼‰
  shopConsumables = shopConsumables.filter(x=>x.name !== item.name);

  renderShop();
  saveProgress();
}


/* é–‹å•†åº—æ™‚è‹¥é‚„æ²’æŠ½è²¨ï¼Œå°±æŠ½ä¸€æ¬¡ä¸¦æ¸²æŸ“ */
function ensureShopOffers(){
  if(shopTools.length === 0 && shopConsumables.length === 0){
    generateShopOffers();
  }
  renderShop();
}

function refreshShopForNewLevel(){
  generateShopOffers(); // 6 éš¨æ©Ÿ + å›ºå®šæ”¾æœ€å¾Œ + æ¶ˆè€—å“2
  renderShop();
}

function findToolDefByName(name){
  return TOOL_DATA.find(x => x.name === name) || null;
}
function findConsumableDefByName(name){
  return CONSUMABLE_DATA.find(x => x.name === name) || null;
}

function isSellableOwned(type, name){
  if(type === 'tool'){
    const def = findToolDefByName(name);
    // é è¨­å¯è³£ï¼šæ²’å®šç¾©å°±ç•¶ true
    return def?.sellable !== false;
  }else{
    const def = findConsumableDefByName(name);
    return def?.sellable !== false;
  }
}



/* =========================================================
   å·¥å…·
========================================================= */
function isFaceCard(c){
  return ['J','Q','K','A'].includes(c.rank);
}

function shuffle(array){
  for(let i=array.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [array[i],array[j]] = [array[j],array[i]];
  }
}

function stageToChinese(n){
  const map = {1:"ä¸€",2:"äºŒ",3:"ä¸‰"};
  return map[n] || String(n);
}

function selectedCount(){
  return document.querySelectorAll('.card.selected').length;
}
function getSelectedCardIds(){
  return [...document.querySelectorAll('.card.selected')].map(el => el.dataset.id);
}

function removeCardsFromHandByIds(ids){
  const removed = [];
  ids.forEach(id=>{
    const idx = hand.findIndex(c => (c.suit + c.rank) === id);
    if(idx !== -1){
      removed.push(hand.splice(idx,1)[0]);
    }
  });
  return removed;
}

let toastTimer = null;
function showToastText(text, ms=900){
  toast.textContent = text;
  toast.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>{
    toast.classList.remove('show');
  }, ms);
}

function updateActionButtons(){
  const hasSelected = selectedCount() > 0;
  btnPlay.disabled = !hasSelected || hp <= 0;                 // æ²’é¸ç‰Œ / æ²’è¡€ ä¸èƒ½è£œçµ¦
  btnDiscard.disabled = !hasSelected || discardsLeft <= 0;    // æ²’é¸ç‰Œ / æ²’æ£„ç‰Œæ¬¡æ•¸ ä¸èƒ½ä¸Ÿæ£„
}

function updateHUD(){
  // å¤§é—œä¸­æ–‡ï¼šç¬¬Xå¤§é—œ
  hudStageText.textContent = `ç¬¬${stageToChinese(bigStage)}å¤§é—œ`;

  hudFuel.textContent = fuel;
  hudTarget.textContent = targetFuel;
  hudDiscards.textContent = discardsLeft;

  if(hudDeck) hudDeck.textContent = drawPile?.length ?? 0;

  // è¡€æ¢
  const ratio = maxHP > 0 ? (hp / maxHP) : 0;
  hpFill.style.width = `${Math.max(0, Math.min(1, ratio)) * 100}%`;
  hpText.textContent = `HP: ${hp}/${maxHP}`;

  // æ˜Ÿçƒå + ä¸­å¤®åœ–ç‰‡
  const info = LEVELS[levelIndex];
  levelNameEl.textContent = info?.name ?? "ï¼ˆæœªçŸ¥æ˜Ÿçƒï¼‰";
  planetImageEl.src = info?.image || "";
  planetImageEl.style.display = (planetImageEl.src ? "" : "none");

  updateTopUILayout();
}

function computePassCoins(baseCoins){
  let coins = baseCoins;

  // ===== é€šé—œé‡‘å¹£ +10% =====
  if(ownedTools.has("é€šé—œé‡‘å¹£ +10%")){
    coins *= 1.10;
  }

  // ===== è‹¥æœ¬é—œæœªä½¿ç”¨æ£„ç‰Œï¼Œé€šé—œé‡‘å¹£ +30% =====
  if(
    ownedTools.has("è‹¥æœ¬é—œæœªä½¿ç”¨æ£„ç‰Œï¼Œé€šé—œé‡‘å¹£ +30%")
    && discardsLeft === DISCARD_PER_LEVEL
  ){
    coins *= 1.30;
  }

  // ç„¡æ¢ä»¶æ¨å»
  return Math.floor(coins);
}

function findToolDefByName(name){
  return TOOL_DATA.find(x => x.name === name) || null;
}
function findConsumableDefByName(name){
  return CONSUMABLE_DATA.find(x => x.name === name) || null;
}

function isSellableOwned(type, name){
  if(type === 'tool'){
    const def = findToolDefByName(name);
    // é è¨­å¯è³£ï¼šæ²’å®šç¾©å°±ç•¶ true
    return def?.sellable !== false;
  }else{
    const def = findConsumableDefByName(name);
    return def?.sellable !== false;
  }
}

function resolveSupply(outCards, stageCountForThisSupply){
  let base = evaluateHand(outCards);
  let type = base.type;

  // âœ… ä¸‹ä¸€æ¬¡è£œçµ¦ç‰Œå‹ç­‰ç´š +1ï¼ˆä¸€æ¬¡æ€§ï¼‰
  if(tempEffects.nextSupplyHandRankPlus1 > 0){
    type = handTypeUpgraded(type, tempEffects.nextSupplyHandRankPlus1);
    tempEffects.nextSupplyHandRankPlus1 = 0;
  }

  let fuelGain = FUEL_BY_HANDTYPE[type] ?? base.fuelGain;
  const cardCount = outCards.length;

  supplyCountInLevel += 1;
  const isNewHandTypeInLevel = !usedHandTypesInLevel.has(type);
  usedHandTypesInLevel.add(type);

  const straightIndex = HAND_TYPE_ORDER.indexOf("é †å­");
  const typeIndex = HAND_TYPE_ORDER.indexOf(type);
  const isStraightOrBetter = typeIndex >= straightIndex;

  let hpGain = 0;
  if(ownedTools.has("æ¯é—œé¦–æ¬¡è£œçµ¦å›å¾© 1 HP") && supplyCountInLevel === 1){
    hpGain += 1;
  }
  if(ownedTools.has("æ¯é—œæ¯ä½¿ç”¨ä¸€ç¨®æ–°ç‰Œå‹ï¼Œå›å¾© 1 HP") && isNewHandTypeInLevel){
    hpGain += 1;
  }
  if(
    ownedTools.has("æ¯é—œé¦–æ¬¡è£œçµ¦é †å­ä»¥ä¸Šç‰Œå‹ï¼Œå›å¾© 1 HP")
    && isStraightOrBetter
    && !straightPlusSupplyUsedInLevel
  ){
    hpGain += 1;
    straightPlusSupplyUsedInLevel = true;
  }
  if(hpGain > 0){
    healHp(hpGain);
    updateHUD();
  }

  const isFaceOnly = outCards.every(c => ['J','Q','K','A'].includes(c.rank));

  /* ===== å…ˆåƒã€Œæš«æ™‚æ•ˆæœã€ï¼ˆåƒå®Œå°±æ¸…ï¼‰===== */

  // âœ… æ¶ˆè€—å“ï¼šä¸‹ä¸€æ¬¡ä½ç‰Œå‹ +25
  if(tempEffects.nextSupplyLowHandBonus > 0){
    if(type === "é«˜ç‰Œ" || type === "ä¸€å°" || type === "å…©å°"){
      fuelGain += tempEffects.nextSupplyLowHandBonus;
    }
    tempEffects.nextSupplyLowHandBonus = 0;
  }

  // âœ… é“å…·ï¼šé«˜ç‰Œçš„ä¸‹æ¬¡è£œçµ¦ +50%
  if(tempEffects.nextSupplyFuelMult && tempEffects.nextSupplyFuelMult !== 1){
    fuelGain *= tempEffects.nextSupplyFuelMult;
    tempEffects.nextSupplyFuelMult = 1;
  }

  // âœ… é“å…·ï¼šæ£„ç‰Œç´¯ç©ï¼Œä¸‹æ¬¡è£œçµ¦ +X%
  if(tempEffects.nextSupplyFuelPctFromDiscard > 0){
    fuelGain *= (1 + tempEffects.nextSupplyFuelPctFromDiscard);
    tempEffects.nextSupplyFuelPctFromDiscard = 0;
  }

  /* ===== ç‡ƒæ–™ä¿®æ­£ï¼ˆæ°¸ä¹…é“å…·ï¼‰===== */

  if(ownedTools.has("äººé ­ç‰Œ +5 ç‡ƒæ–™")){
    const faceCount = outCards.filter(c => ['J','Q','K','A'].includes(c.rank)).length;
    fuelGain += faceCount * 5;
  }

  if(ownedTools.has("æ¯é—œé¦–æ¬¡è£œçµ¦ +30% ç‡ƒæ–™") && supplyCountInLevel === 1){
    fuelGain *= 1.3;
  }

  if(ownedTools.has("è£œçµ¦ +20 ç‡ƒæ–™ï¼Œæ¯æ¬¡é€šé—œå¾Œå†æ°¸ä¹… +2 ç‡ƒæ–™")){
    fuelGain += 20 + supplyBonusPerClear;
  }

  if(ownedTools.has("ä¸€é—œå…§æ¯æ¬¡è£œçµ¦ï¼Œé¡å¤– +3 ç‡ƒæ–™")){
    fuelGain += supplyCountInLevel * 3;
  }

  if(ownedTools.has("è‹¥è£œçµ¦åªå«äººé ­ç‰Œï¼Œ+20% ç‡ƒæ–™") && isFaceOnly){
    fuelGain *= 1.2;
  }

  if(ownedTools.has("è‹¥è£œçµ¦åŒ…å«3å¼µç‰Œä»¥ä¸Šï¼Œ+20% ç‡ƒæ–™") && cardCount >= 3){
    fuelGain *= 1.2;
  }

  if(ownedTools.has("ç›®å‰ç‰Œçµ„æ¯å°‘1å¼µç‰Œ +2 ç‡ƒæ–™")){
    const currentDeckSize = (drawPile?.length ?? 0) + (hand?.length ?? 0);
    const missingCards = Math.max(0, deck.length - currentDeckSize);
    fuelGain += missingCards * 2;
  }

  if(ownedTools.has("ä¸€é—œå…§æ¯ä½¿ç”¨éä¸€ç¨®ç‰Œå‹ +6 ç‡ƒæ–™")){
    fuelGain += usedHandTypesInLevel.size * 6;
  }

  if(
    ownedTools.has("åœ¨ã€æ¥µç«¯æº«å·®ã€‘æ˜Ÿçƒè£œçµ¦ +15% ç‡ƒæ–™")
    && hasLevelTrait("æ¥µç«¯æº«å·®")
  ){
    fuelGain *= 1.15;
  }

  if(
    ownedTools.has("åœ¨ã€æ¥µç«¯æ°£å€™ã€‘æ˜Ÿçƒçš„é¦–æ¬¡è£œçµ¦ +20% ç‡ƒæ–™")
    && hasLevelTrait("æ¥µç«¯æ°£å€™")
    && supplyCountInLevel === 1
  ){
    fuelGain *= 1.2;
  }

  if(
    ownedTools.has("åœ¨ã€åœ°è³ªé«˜åº¦æ´»èºã€‘æ˜Ÿçƒçš„è£œçµ¦åŒ…å« 3 å¼µæˆ–ä»¥ä¸‹æ™‚ï¼Œç‡ƒæ–™ +25%")
    && hasLevelTrait("åœ°è³ªé«˜åº¦æ´»èº")
    && cardCount <= 3
  ){
    fuelGain *= 1.25;
  }

  if(
    ownedTools.has("åœ¨ã€é«˜å£“ç’°å¢ƒã€‘æ˜Ÿçƒè£œçµ¦ +10 ç‡ƒæ–™")
    && hasLevelTrait("é«˜å£“ç’°å¢ƒ")
  ){
    fuelGain += 10;
  }

  if(
    ownedTools.has("åœ¨ã€æ¥µç«¯ä½æº«ã€‘æ˜Ÿçƒçš„é¦–æ¬¡è£œçµ¦ +15 ç‡ƒæ–™")
    && hasLevelTrait("æ¥µç«¯ä½æº«")
    && supplyCountInLevel === 1
  ){
    fuelGain += 15;
  }

  const planetBonusHands = PLANET_HANDTYPE_BONUS[type] ?? [];
  if(planetBonusHands.includes(getCurrentLevelInfo().name)){
    fuelGain *= 1.5;
  }

  fuelGain = Math.floor(fuelGain);

  /* ===== è§¸ç™¼ï¼šé«˜ç‰Œçš„ä¸‹æ¬¡è£œçµ¦ +50% ===== */
  if(ownedTools.has("é«˜ç‰Œçš„ä¸‹æ¬¡è£œçµ¦ +50% ç‡ƒæ–™") && type === "é«˜ç‰Œ"){
    tempEffects.nextSupplyFuelMult = Math.max(tempEffects.nextSupplyFuelMult, 1.5);
  }

  /* ===== HP çµç®—ï¼ˆâœ…ä¿® bugï¼šç”¨ stageCountForThisSupply åˆ¤æ–·ï¼‰===== */
  let hpDelta = 0;
  const hpRule = tempEffects.supplyHpOverride?.per
    ?? SUPPLY_PER_HP_BY_STAGE[bigStage]
    ?? 3;

  if(stageCountForThisSupply % hpRule === 0){
    if(ownedTools.has("æ¯é—œå…ç–«ç¬¬ä¸€æ¬¡å‚·å®³") && !immuneHitUsedInLevel){
      immuneHitUsedInLevel = true;
    }else{
      hpDelta = -1;
    }
  }

  /* ===== é¡å¤–å›å‚³ï¼š5å¼µè£œçµ¦ +1æ£„ç‰Œ ===== */
  let extraDiscards = 0;
  if(ownedTools.has("è‹¥è£œçµ¦åŒ…å«5å¼µç‰Œï¼Œç•¶å±€ç²å¾—1æ¬¡æ£„ç‰Œæ¬¡æ•¸") && cardCount === 5){
    extraDiscards += 1;
  }

  return { type, fuelGain, hpDelta, cardCount, extraDiscards };
}

function getCurrentLevelInfo(){
  return LEVELS[levelIndex] || LEVELS[0];
}

function hasLevelTrait(trait){
  const info = getCurrentLevelInfo();
  return Array.isArray(info.traits) && info.traits.includes(trait);
}

function armConsumablesBeforeSupply(){
  // 1) ä¸‹ä¸€æ¬¡è£œçµ¦ï¼šå…¨éƒ¨ä¸ç§»é™¤ï¼ˆä¸€æ¬¡æ€§ï¼‰
  if(!tempEffects.nextSupplyNoRemove && hasConsumable("ä¸‹ä¸€æ¬¡è£œçµ¦ä½¿ç”¨çš„ç‰Œå…¨éƒ¨ä¸ç§»é™¤")){
    tempEffects.nextSupplyNoRemove = true;
    consumeConsumable("ä¸‹ä¸€æ¬¡è£œçµ¦ä½¿ç”¨çš„ç‰Œå…¨éƒ¨ä¸ç§»é™¤");
  }

  // 2) ä¸‹ä¸€æ¬¡è£œçµ¦ï¼šç‰Œå‹ç­‰ç´š +1ï¼ˆä¸€æ¬¡æ€§ï¼‰
  if(tempEffects.nextSupplyHandRankPlus1 <= 0 && hasConsumable("ä¸‹ä¸€æ¬¡è£œçµ¦çš„ç‰Œå‹ç­‰ç´š +1")){
    tempEffects.nextSupplyHandRankPlus1 = 1;
    consumeConsumable("ä¸‹ä¸€æ¬¡è£œçµ¦çš„ç‰Œå‹ç­‰ç´š +1");
  }

  // 3) ä¸‹ä¸€æ¬¡è£œçµ¦ï¼šä½ç‰Œå‹ +25ï¼ˆä¸€æ¬¡æ€§ï¼‰
  if(tempEffects.nextSupplyLowHandBonus <= 0 && hasConsumable("ä¸‹ä¸€æ¬¡è£œçµ¦è‹¥ç‚ºé«˜ç‰Œ/ä¸€å°/å…©å°ï¼Œ +25 ç‡ƒæ–™")){
    tempEffects.nextSupplyLowHandBonus = 25;
    consumeConsumable("ä¸‹ä¸€æ¬¡è£œçµ¦è‹¥ç‚ºé«˜ç‰Œ/ä¸€å°/å…©å°ï¼Œ +25 ç‡ƒæ–™");
  }

  // 4) æ‰£è¡€é »ç‡æ”¹ç‚º 4 æ¬¡è£œçµ¦ï¼ˆæŒçºŒä¸€é—œï¼‰
  // è¦å‰‡ï¼šåŒä¸€é—œè‹¥å·²ç”Ÿæ•ˆå‰‡å¿½ç•¥ï¼ˆä¸æ¶ˆè€—ï¼‰ï¼Œç•™åˆ°ä¸‹ä¸€é—œå†ç”¨ã€‚
  if(!tempEffects.supplyHpOverride && hasConsumable("æ‰£è¡€é »ç‡æ”¹ç‚º4æ¬¡è£œçµ¦ï¼ŒæŒçºŒä¸€é—œ")){
    tempEffects.supplyHpOverride = { per: 4 };
    consumeConsumable("æ‰£è¡€é »ç‡æ”¹ç‚º4æ¬¡è£œçµ¦ï¼ŒæŒçºŒä¸€é—œ");
  }

  // 5) æ¥µç«¯ä½æº«ï¼šä¸‹ä¸€æ¬¡è£œçµ¦ +30%ï¼ˆä¸€æ¬¡æ€§ï¼‰
  if(hasConsumable("åœ¨ã€æ¥µç«¯ä½æº«ã€‘æ˜Ÿçƒçš„ä¸‹ä¸€æ¬¡è£œçµ¦ +30% ç‡ƒæ–™") && hasLevelTrait("æ¥µç«¯ä½æº«")){
    // ï¼ˆèˆ‡é«˜ç‰Œ+50%å…±å­˜ï¼‰
    tempEffects.nextSupplyFuelMult = Math.max(tempEffects.nextSupplyFuelMult, 1.3);
    consumeConsumable("åœ¨ã€æ¥µç«¯ä½æº«ã€‘æ˜Ÿçƒçš„ä¸‹ä¸€æ¬¡è£œçµ¦ +30% ç‡ƒæ–™");
  }
}

/* =========================================================
   æ¶ˆè€—å“ï¼šæŠ½2é¸1åŠ å…¥æ‰‹ç‰Œï¼ˆå¦ä¸€å¼µå›ç‰Œåº«ï¼‰
========================================================= */
let pickOverlayEl = null;

function openPick2Overlay(twoCards, onPick){
  if(isShopOpen) closeShop();
  setGamePaused(true);

  pickOverlayEl = document.createElement('div');
  pickOverlayEl.id = 'pick2-overlay';
  pickOverlayEl.style.cssText = `
    position:fixed; inset:0; z-index:9999;
    display:flex; align-items:center; justify-content:center;
    background:rgba(0,0,0,0.65);
  `;

  pickOverlayEl.innerHTML = `
    <div style="
      width: min(80vw, 860px);
      max-height: 80vh;
      background: rgba(10,12,16,0.96);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 16px;
      padding: 22px 18px;
      box-shadow: 0 12px 40px rgba(0,0,0,0.55);
      text-align: center;
      overflow: auto;
    ">
      <div style="font-size:18px; font-weight:800; margin-bottom:14px;">
        è«‹é¸æ“‡ä¸€å¼µ
      </div>

      <div style="display:flex; gap:14px; justify-content:center;">
        ${twoCards.map((c, idx)=>`
          <div class="pick-card" data-idx="${idx}" style="
            width:160px; max-width:38vw;
            border-radius:12px;
            border:1px solid rgba(255,255,255,0.12);
            background:rgba(255,255,255,0.03);
            padding:10px;
            cursor:pointer;
            transition:transform .12s ease;
          ">
            <img src="${CARD_IMAGE_PATH + c.img}" style="width:100%; display:block; border-radius:10px;">
          </div>
        `).join('')}
      </div>

      <div style="opacity:0.75; margin-top:12px; font-size:12px;">
        é¸ä¸­å¾Œï¼šè©²ç‰ŒåŠ å…¥æ‰‹ç‰Œï¼Œå¦ä¸€å¼µå›ç‰Œåº«
      </div>
    </div>
  `;

  document.body.appendChild(pickOverlayEl);

  pickOverlayEl.querySelectorAll('.pick-card').forEach(el=>{
    el.addEventListener('mouseenter', ()=> el.style.transform = 'translateY(-2px)');
    el.addEventListener('mouseleave', ()=> el.style.transform = 'translateY(0)');
  });

  let done = false;
  pickOverlayEl.addEventListener('click', (e)=>{
    if(done) return;

    const cardEl = e.target.closest('.pick-card');
    if(!cardEl) return; // é»åˆ°é»‘èƒŒæ™¯å°±å¿½ç•¥ï¼Œä»å¯ç¹¼çºŒé¸

    done = true;
    const idx = Number(cardEl.dataset.idx);
    onPick(idx);

    pickOverlayEl.remove();
    pickOverlayEl = null;

    renderHand();
    updateHUD();
    setGamePaused(false);
    saveProgress();
  });
}

function useConsumable_Draw2Pick1(){
  // ç‰Œåº«ä¸è¶³ï¼šèƒ½æŠ½å¹¾å¼µå°±æŠ½å¹¾å¼µï¼Œä½†å°‘æ–¼2å°±ç›´æ¥æç¤º
  if(!drawPile || drawPile.length === 0){
    showToastText('ç‰Œåº«æ²’æœ‰ç‰Œäº†', 1000);
    return;
  }

  const take = Math.min(2, drawPile.length);
  const picked = [];
  for(let i=0;i<take;i++){
    picked.push(drawPile.pop());
  }

  if(picked.length < 2){
    // æŠ½ä¸åˆ° 2 å¼µï¼šå°±æŠŠæŠ½åˆ°çš„æ”¾å›å»
    drawPile.push(...picked);
    shuffle(drawPile);
    showToastText('ç‰Œåº«ä¸è¶³ 2 å¼µï¼Œç„¡æ³•ä½¿ç”¨', 1100);
    return;
  }

  openPick2Overlay(picked, (idx)=>{
    const chosen = picked[idx];
    const other = picked[1 - idx];

    // âœ… è¢«é¸ä¸­çš„åŠ å…¥æ‰‹ç‰Œï¼ˆå…è¨±è¶…ä¸Šé™ï¼‰
    hand.push(chosen);

    // âœ… å¦ä¸€å¼µå›ç‰Œåº«ä¸¦æ´—
    drawPile.push(other);
    shuffle(drawPile);

    showToastText('å·²åŠ å…¥æ‰‹ç‰Œï¼ˆä¸‹æ¬¡è£œç‰Œ -1ï¼‰', 1200);
  });
}


/* =========================================================
   æŠ½ç‰Œ / ç™¼ç‰Œ / UI render
========================================================= */
function initBigStageResetDeck(){
  // æ¯éä¸€å¤§é—œï¼Œç‰Œåº«é‡ç½®ç‚ºå®Œæ•´ 52 å¼µ
  drawPile = [...deck];
  shuffle(drawPile);
  played = [];
}

function drawFromPile(n){
  for(let i=0;i<n;i++){
    if(drawPile.length <= 0){
      showToastText('ç‰Œåº«å·²ç©º', 1100);
      break;
    }
    hand.push(drawPile.pop());
  }
}

function renderHand(){
  handCards.innerHTML = '';

  // ä¾è¦æ ¼æ’åºé¡¯ç¤ºï¼ˆä½† hand æœ¬èº«ä¸å¿…çœŸçš„é‡æ’ä¹Ÿæ²’é—œä¿‚ï¼‰
  const sorted = [...hand];
  sortHand(sorted);

  sorted.forEach(cardData=>{
    const card = document.createElement('div');
    card.className = 'card';
    card.dataset.rank = cardData.rank;
    card.dataset.suit = cardData.suit;
    card.dataset.id = cardData.suit + cardData.rank;

    const img = document.createElement('img');
    img.src = CARD_IMAGE_PATH + cardData.img;

    card.appendChild(img);

    card.addEventListener('click',()=>{
      if(card.classList.contains('selected')){
        card.classList.remove('selected');
        updateActionButtons();
        return;
      }
      if(selectedCount() >= MAX_SELECT){
        showToastText('å·²é”å‡º/æ£„ç‰Œä¸Šé™', 900);
        return;
      }
      card.classList.add('selected');
      updateActionButtons();
    });

    handCards.appendChild(card);
  });

  updateActionButtons();
}

/* =========================================================
   ç‰Œå‹åˆ¤æ–·ï¼ˆæœ€å¤š 5 å¼µï¼‰
========================================================= */
function rankValue(r){
  return RANK_ORDER.indexOf(r); // 0..12
}

function normalizedSuit(s){
  // ä¾é“å…·æŠŠèŠ±è‰²åˆä½µæˆã€ŒåŒèŠ±è‰²ç¾¤çµ„ã€
  if(ownedTools.has("é»‘æ¡ƒå’Œæ¢…èŠ±è¦–ç‚ºåŒèŠ±è‰²")){
    if(s === 'S' || s === 'C') return 'SC';
  }
  if(ownedTools.has("ç´…å¿ƒå’Œæ–¹å¡Šè¦–ç‚ºåŒèŠ±è‰²")){
    if(s === 'H' || s === 'D') return 'HD';
  }
  return s;
}

function isRoyalRanks(ranks, allow4){
  const set = new Set(ranks);
  if(allow4){
    // 4 å¼µçš‡å®¶ï¼šJQKAï¼ˆè¦å‰‡ï¼šéœ€æœ‰ã€Œåƒ…éœ€4å¼µç‰Œå³å¯æ§‹ç¯‰é †å­ã€åŒèŠ±ã€ï¼‰
    return set.size === 4 && ['J','Q','K','A'].every(x => set.has(x));
  }
  // 5 å¼µçš‡å®¶ï¼šTJQKA
  return set.size === 5 && ['T','J','Q','K','A'].every(x => set.has(x));
}

function isStraightStrict(vals){
  // vals: å·²ç”±å°åˆ°å¤§ä¸”å»é‡
  const n = vals.length;
  if(n < 2) return false;

  // ä¸€èˆ¬é †å­ï¼ˆé€£è™Ÿï¼‰
  let ok = true;
  for(let i=1;i<n;i++){
    if(vals[i] !== vals[i-1] + 1){ ok = false; break; }
  }
  if(ok) return true;

  // A2345 ç‰¹ä¾‹ï¼ˆåªåœ¨ 5 å¼µæ™‚æˆç«‹ï¼‰
  if(n === 5){
    const wheel = [0,1,2,3,12];
    for(let i=0;i<5;i++){
      if(vals[i] !== wheel[i]) return false;
    }
    return true;
  }
  return false;
}

function isStraightWithGap1(vals){
  // å…è¨±æ¯ä¸€æ­¥å·® 1 æˆ–å·® 2ï¼ˆå¯æ’ 1 å¼µï¼‰
  const n = vals.length;
  if(n < 2) return false;

  for(let i=1;i<n;i++){
    const d = vals[i] - vals[i-1];
    if(d !== 1 && d !== 2) return false;
  }
  return true;
}

function handTypeUpgraded(type, step){
  if(!step) return type;

  const i = HAND_TYPE_ORDER.indexOf(type);
  if(i === -1) return type;

  const j = Math.min(HAND_TYPE_ORDER.length - 1, i + step);
  return HAND_TYPE_ORDER[j];
}

function evaluateHand(cards){
  const n = cards.length;
  if(n === 0) return { type:"é«˜ç‰Œ", fuelGain:0 };

  const allow4SF = ownedTools.has("åƒ…éœ€4å¼µç‰Œå³å¯æ§‹ç¯‰é †å­ã€åŒèŠ±");
  const gap1Straight = ownedTools.has("é †å­ç‰Œå‹æ¯å¼µç‰Œå¯ç›¸å·®1é»");

  const ranks = cards.map(c=>c.rank);
  const suits = cards.map(c=>normalizedSuit(c.suit));

  // ===== å°å­/ä¸‰æ¢/è‘«è˜†/éµæ”¯ =====
  const counts = {};
  ranks.forEach(r => counts[r] = (counts[r]||0) + 1);
  const countList = Object.values(counts).sort((a,b)=>b-a);

  // ===== åŒèŠ±ï¼ˆåƒåˆä½µèŠ±è‰²ï¼‰=====
  const isFlush = suits.every(s => s === suits[0]);

  // ===== é †å­ =====
  const valsRaw = ranks.map(rankValue).sort((a,b)=>a-b);
  const vals = [...new Set(valsRaw)];
  let isStraight = false;

  const canCheckStraight = (n === 5) || (allow4SF && n === 4);

  if(canCheckStraight && vals.length === n){
    if(gap1Straight){
      // gap1 æ”¾å¯¬ï¼šå·® 1 æˆ–å·® 2ï¼›ä»ä¿ç•™ A2345 strict ç‰¹åˆ¤
      isStraight = isStraightWithGap1(vals) || isStraightStrict(vals);
    }else{
      isStraight = isStraightStrict(vals);
    }
  }

  // ===== ç‰Œå‹åˆ¤å®š =====
  let type = "é«˜ç‰Œ";

  // çš‡å®¶åŒèŠ±é †ï¼šä¸€å®šè¦åŒèŠ± + é †å­ + ç²¾æº– ranks
  const isRoyal =
    isFlush &&
    isStraight &&
    (
      (n === 5 && isRoyalRanks(ranks, false)) ||
      (allow4SF && n === 4 && isRoyalRanks(ranks, true))
    );

  if(isRoyal){
    type = "çš‡å®¶åŒèŠ±é †";
  }else if((n === 5 || (allow4SF && n === 4)) && isStraight && isFlush){
    type = "åŒèŠ±é †";
  }else if(countList[0] === 4){
    type = "éµæ”¯";
  }else if(countList[0] === 3 && countList[1] === 2){
    type = "è‘«è˜†";
  }else if((n === 5 || (allow4SF && n === 4)) && isFlush){
    type = "åŒèŠ±";
  }else if((n === 5 || (allow4SF && n === 4)) && isStraight){
    type = "é †å­";
  }else if(countList[0] === 3){
    type = "ä¸‰æ¢";
  }else if(countList[0] === 2 && countList[1] === 2){
    type = "å…©å°";
  }else if(countList[0] === 2){
    type = "ä¸€å°";
  }else{
    type = "é«˜ç‰Œ";
  }

  const fuelGain = FUEL_BY_HANDTYPE[type] ?? 0;
  return { type, fuelGain };
}

/* =========================================================
   é—œå¡æµç¨‹
========================================================= */
function startLevel(){
  const info = LEVELS[levelIndex];

  bigStage = info.stage;
  targetFuel = info.targetFuel;
  maxHP = computeMaxHP();
  hp = Math.max(0, hp);
  if(hp <= maxHP) hp = maxHP;
  applyTestStartHp(); // æ¸¬è©¦å·¥å…·

  resetLevelState();

  initBigStageResetDeck();

  // ç™¼æ‰‹ç‰Œ
  const injected = applyTestInitialHand();
  if(!injected){
    hand = [];
  }
  const targetHandSize = Math.min(HAND_SIZE, HAND_SIZE_MAX);
  const drawCount = Math.max(0, targetHandSize - hand.length);
  drawFromPile(drawCount);
  renderHand();

  updateHUD();
  updateTopUILayout();
}

/* ===== é€šé—œå½ˆçª— ===== */
const passText = document.getElementById('pass-text');
const passOverlay = document.getElementById('pass-overlay');
const passContinue = document.getElementById('pass-continue');

let isPassOpen = false;

function openPassModal(){
  isPassOpen = true;
  passOverlay.style.display = 'flex';

  // é€šé—œå½ˆçª—å‡ºç¾ï¼šæš«åœéŠæˆ² + é¿å…å•†åº—/è¦å‰‡ç–Šé–‹
  setGamePaused(true);
  shopBtn.style.pointerEvents = 'none';
  rulesBtn.style.pointerEvents = 'none';
}

function closePassModal(){
  isPassOpen = false;
  passOverlay.style.display = 'none';

  // é€šå¸¸é€šé—œå¾Œæœƒç›´æ¥è·³é ï¼Œæ‰€ä»¥é€™è£¡ä¸å¤ªæœƒç”¨åˆ°
  setGamePaused(false);
  shopBtn.style.pointerEvents = 'auto';
  rulesBtn.style.pointerEvents = 'auto';
}

function passLevel(){
  const info = LEVELS[levelIndex] || LEVELS[0];
  const gainCoins = computePassCoins(info.passCoins);

  passText.textContent =
    `ç²å¾— ${gainCoins} é‡‘å¹£ï¼ŒæŒ‰ä¸‹ã€Œç¹¼çºŒã€é€²å…¥çŸ¥è­˜é ã€‚`;

  openPassModal();
}

/* æŒ‰ã€Œç¹¼çºŒã€æ‰çœŸçš„åšçµç®—/å­˜æª”/è·³çŸ¥è­˜é  */
passContinue.addEventListener('click', ()=>{
  const info = LEVELS[levelIndex] || LEVELS[0];
  const gainCoins = computePassCoins(info.passCoins);
  const nextInfo = LEVELS[levelIndex + 1];
  const isStageClear = !nextInfo || nextInfo.stage !== info.stage;

  // 1) ç™¼é€šé—œé‡‘å¹£
  coins += gainCoins;

  // 2) é€šé—œæ‰åˆ·æ–°å•†åº—
  generateShopOffers();

  // 3) é€šé—œæ°¸ä¹…æˆé•·
  if(ownedTools.has("è£œçµ¦ +20 ç‡ƒæ–™ï¼Œæ¯æ¬¡é€šé—œå¾Œå†æ°¸ä¹… +2 ç‡ƒæ–™")){
    supplyBonusPerClear += 2;
  }

  if(isStageClear){
    bigStageClearCount += 1;
  }

  // 4) é€šé—œå›è¡€é“å…·ï¼ˆåªåœ¨é€šé—œæ™‚è§¸ç™¼ï¼‰
  if(ownedTools.has("é€šé—œæ™‚è‹¥ HP â‰¤ 2ï¼Œå›å¾©è‡³ 3") && hp <= 2){
    hp = 3;
  }

  updateHUD();

  // 5) å­˜æª”ä¸¦é‡ç½® fuel
  // !!! å·²æ”¾æ£„localStorageå­˜æª”æ–¹æ³•ï¼Œå› ç‚ºç„¡æ³•è§£æ±ºoriginä¸åŒå°è‡´è®€å–ä¸åˆ°å­˜å…¥çš„è³‡æ–™ï¼Œæ”¹æˆå°‡çŸ¥è­˜é ä½µå…¥éŠæˆ²é 
  fuel = 0;
  saveProgress();

  // 6) è·³çŸ¥è­˜é ï¼ˆçŸ¥è­˜é ç”¨ levelIndex æ±ºå®šå…§å®¹ï¼‰
  // location.href = "https://bonbonchou.github.io/The_Great_Solar_System_Adventure/intro.html";
  renderStar(levelIndex);
});


window.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape' && isPassOpen){
    // é€šé—œå½ˆçª—é€šå¸¸ä¸çµ¦é—œæ‰ï¼Œé¿å…ç©å®¶å¡é—œï¼›æ‰€ä»¥é€™è£¡ä¸åš close
    // å¦‚æœæƒ³å…è¨±é—œé–‰ï¼Œå°±æ”¹æˆ closePassModal();
    e.preventDefault();
  }
});

/* ===== å¤±æ•—å½ˆçª— ===== */
const failOverlay = document.getElementById('fail-overlay');
const failRetry = document.getElementById('fail-retry');
const failRestart = document.getElementById('fail-restart');
const failSummary = document.getElementById('fail-summary');
const failText = document.getElementById('fail-text');

let isFailOpen = false;

function openFailModal(){
  isFailOpen = true;
  failOverlay.style.display = 'flex';

  // æš«åœéŠæˆ² + ç¦æ­¢å…¶å®ƒ icon ç–Šé–‹
  setGamePaused(true);
  shopBtn.style.pointerEvents = 'none';
  rulesBtn.style.pointerEvents = 'none';
}

function closeFailModal(){
  isFailOpen = false;
  failOverlay.style.display = 'none';

  shopBtn.style.pointerEvents = 'auto';
  rulesBtn.style.pointerEvents = 'auto';
}

function showFinalScreen(scoreLevelIndex){
  document.getElementById("game-screen").classList.add("hidden");
  document.getElementById("info-screen").classList.add("hidden");
  document.getElementById("final-screen").classList.remove("hidden");

  const info = LEVELS[scoreLevelIndex] || LEVELS[0];
  const stageLabel = `ç¬¬${stageToChinese(info.stage)}å¤§é—œ`;
  const scoreText = `ä½ çš„æˆç¸¾ï¼š${stageLabel}â€”â€”${info.name}`;

  document.getElementById("endscore-display").textContent = scoreText;
}

function endGameSummary(){
  closeFailModal();
  saveProgress();
  showFinalScreen(levelIndex);
}

/* ===== æœ¬é—œé‡æ–°é–‹å§‹ï¼ˆä¸å‹• levelIndexï¼Œä¸å‹•å·²æ“æœ‰/é‡‘å¹£/å•†åº—è²¨æ¶ï¼‰ ===== */
function restartCurrentLevel(){
  closeFailModal();

  // é—œå¡åŸºæœ¬æ•¸å€¼é‡ç½®
  const info = LEVELS[levelIndex] || LEVELS[0];
  bigStage = info.stage;
  fuel = 0;
  targetFuel = info.targetFuel;
  maxHP = computeMaxHP();
  hp = maxHP;

  resetLevelState();

  supplyCountInStage = 0;

  // æ‰‹ç‰Œä¸Šé™ HAND_SIZEï¼šç›®å‰æ˜¯ã€Œæ°¸ä¹…é“å…·ã€æœƒæ”¹å®ƒï¼Œæ‰€ä»¥é‡é–‹åˆ¥å‹• HAND_SIZE
  // HAND_SIZE ä¸é‡ç½®

  initBigStageResetDeck();

  // ç™¼ç‰Œ
  hand = [];
  drawFromPile(Math.min(HAND_SIZE, HAND_SIZE_MAX));
  renderHand();
  updateHUD();

  // è®“æŒ‰éˆ•æ¢å¾©å¯æŒ‰
  setGamePaused(false);
}

/* ===== éŠæˆ²é‡é ­é–‹å§‹ï¼ˆæ¸…å­˜æª” + å›åˆ°åˆå§‹ç‹€æ…‹ï¼‰ ===== */
function restartWholeGame(){
  // localStorage.removeItem('gameState');
  location.href = "https://bonbonchou.github.io/The_Great_Solar_System_Adventure/index.html";
}

failRetry.addEventListener('click', restartCurrentLevel);
failRestart.addEventListener('click', restartWholeGame);
failSummary.addEventListener('click', endGameSummary);

window.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape' && isFailOpen){
    // å¤±æ•—çª—ä¸å…è¨± ESC é—œé–‰ï¼Œé¿å…ç©å®¶å¡åœ¨å¤±æ•—ç‹€æ…‹
    e.preventDefault();
  }
});

function gameOver(reason){
  hp = 0;
  if(failText){
    failText.textContent = reason || 'HP æ­¸é›¶äº†ã€‚è¦æ€éº¼åšï¼Ÿ';
  }
  renderHand();
  updateHUD();
  openFailModal();
}

function checkNoCardsFail(){
  if(fuel >= targetFuel){
    return false;
  }
  if((drawPile?.length ?? 0) === 0 && (hand?.length ?? 0) === 0){
    gameOver('ç‰Œåº«å’Œæ‰‹ç‰Œéƒ½ç”¨å®Œäº†ã€‚è¦æ€éº¼åšï¼Ÿ');
    return true;
  }
  return false;
}

/* =========================================================
   è£œçµ¦ï¼ˆå‡ºç‰Œï¼‰ / ä¸Ÿæ£„ï¼ˆæ£„ç‰Œï¼‰
========================================================= */
btnPlay.addEventListener('click', ()=>{
  const ids = getSelectedCardIds();
  if(ids.length === 0) return;

  if(hp <= 0){
    showToastText('æ²’æœ‰ HP äº†', 1000);
    return;
  }

  armConsumablesBeforeSupply();

  const outCards = removeCardsFromHandByIds(ids);

  // âœ… é€™æ¬¡è£œçµ¦åœ¨æœ¬é—œä¸­çš„ã€Œæ¬¡æ•¸ã€ï¼ˆç”¨ä¾†åˆ¤æ–·æ‰£è¡€ï¼‰
  supplyCountInStage += 1;
  const stageCountForThisSupply = supplyCountInStage;

  // âœ… çµç®—
  const result = resolveSupply(outCards, stageCountForThisSupply);
  fuel += result.fuelGain;

  // âœ… ç‰Œå¦‚ä½•å›æ”¶/ç§»é™¤
  const keepAllThisTime = !!tempEffects.nextSupplyNoRemove; // ä¸€æ¬¡æ€§
  const keepFaceThisTime = ownedTools.has("è£œçµ¦å°‡ä¸æœƒç§»é™¤äººé ­ç‰Œ");
  const reduceRemovalThisTime =
    ownedTools.has("åœ¨ã€ç¨€è–„/ç¼ºä¹å¤§æ°£ã€‘æ˜Ÿçƒï¼Œæ¯æ¬¡è£œçµ¦ç§»é™¤çš„ç‰Œéš¨æ©Ÿå°‘ 1 å¼µ")
    && hasLevelTrait("ç¨€è–„/ç¼ºä¹å¤§æ°£");

  function spareOneRemovedCard(removedCards){
    if(!reduceRemovalThisTime || removedCards.length === 0) return;
    const idx = Math.floor(Math.random() * removedCards.length);
    const [spared] = removedCards.splice(idx, 1);
    drawPile.push(spared);
    shuffle(drawPile);
  }

  if(keepAllThisTime){
    drawPile.push(...outCards);
    shuffle(drawPile);
    tempEffects.nextSupplyNoRemove = false;
  }else if(keepFaceThisTime){
    const back = [];
    const removed = [];
    outCards.forEach(c=>{
      if(isFaceCard(c)) back.push(c);
      else removed.push(c);
    });
    if(back.length){
      drawPile.push(...back);
      shuffle(drawPile);
    }
    spareOneRemovedCard(removed);
    if(removed.length){
      played.push(...removed);
    }
  }else{
    const removed = [...outCards];
    spareOneRemovedCard(removed);
    if(removed.length){
      played.push(...removed);
    }
  }

  // âœ… è£œç‰Œï¼ˆè‹¥æœ‰ã€Œè¶…ä¸Šé™æŠ½ç‰Œã€æ•ˆæœ â†’ ä¸‹æ¬¡è£œç‰Œå°‘ 1ï¼‰
  const targetHandSize = Math.min(HAND_SIZE, HAND_SIZE_MAX);
  const refillCount = Math.max(0, targetHandSize - hand.length);
  drawFromPile(refillCount);

  // âœ… æ‰£è¡€
  if(result.hpDelta < 0){
    hp += result.hpDelta;
    if(hp <= 0){
      hp = 0;
      renderHand();
      updateHUD();
      gameOver();
      return;
    }
  }

  // âœ… 5å¼µè£œçµ¦ +1æ£„ç‰Œ
  if(result.extraDiscards){
    levelExtraDiscards += result.extraDiscards;
    discardsLeft += result.extraDiscards;
  }

  renderHand();
  updateHUD();

  showToastText(`${result.type} +${result.fuelGain} ç‡ƒæ–™`, 1500);

  if(fuel >= targetFuel){
    passLevel();
    return;
  }
  if(checkNoCardsFail()){
    return;
  }
});

btnDiscard.addEventListener('click', ()=>{
  const ids = getSelectedCardIds();
  if(ids.length === 0) return;

  const canUseFreeDiscard =
    ownedTools.has("åœ¨ã€å¯èƒ½å­˜åœ¨ç”Ÿå‘½ã€‘æ˜Ÿçƒçš„é¦–æ¬¡æ£„ç‰Œä¸æ¶ˆè€—æ¬¡æ•¸")
    && hasLevelTrait("å¯èƒ½å­˜åœ¨ç”Ÿå‘½")
    && !freeDiscardUsedInLevel;

  if(discardsLeft <= 0){
    showToastText('æœ¬é—œæ£„ç‰Œç”¨å®Œ', 1000);
    return;
  }

  // 1) å…ˆæŠŠæ£„ç‰Œå¾æ‰‹ç‰Œç§»é™¤ï¼ˆæš«å­˜ï¼‰
  const discardCards = removeCardsFromHandByIds(ids);

  // 2) å…ˆæŠ½ç‰Œè£œå›æ‰‹ç‰Œï¼ˆé¿å…ç«‹åˆ»æŠ½å›åŒå¼µï¼‰
  drawFromPile(discardCards.length);

  // 3) å†æŠŠæ£„ç‰Œæ”¾å›ç‰Œåº«ä¸¦æ´—ç‰Œ
  drawPile.push(...discardCards);
  shuffle(drawPile);

  const freeDiscardThisTime = canUseFreeDiscard;
  if(freeDiscardThisTime){
    freeDiscardUsedInLevel = true;
  }else{
    discardsLeft -= 1;
  }
  // âœ… é“å…·ï¼šæ¯æ£„1å¼µç‰Œï¼Œä¸‹æ¬¡è£œçµ¦ +5%
  if(ownedTools.has("æ¯æ£„1å¼µç‰Œï¼Œä¸‹æ¬¡è£œçµ¦ç²å¾—ç‡ƒæ–™ +5%")){
    tempEffects.nextSupplyFuelPctFromDiscard += 0.05 * discardCards.length;
    tempEffects.nextSupplyFuelPctFromDiscard = Math.min(1.0, tempEffects.nextSupplyFuelPctFromDiscard);
  }

  renderHand();
  updateHUD();

  showToastText(`ä¸Ÿæ£„ï¼š${discardCards.length} å¼µ`, 800);
});

const shopBtn = document.getElementById('shop-btn');
shopBtn.addEventListener('click', openShop);

/* =========================================================
   è¦å‰‡å…§å®¹ï¼ˆä»»æ„å¢æ¸›é æ•¸ï¼‰
========================================================= */
const RULE_PAGES = [
  {
    title: "åŸºæœ¬ç©æ³•",
    body: [
      "æ¯æ¬¡è£œçµ¦æœ€å¤šé¸ 5 å¼µç‰Œã€‚",
      "ä¾ç‰Œå‹ç²å¾—ç‡ƒæ–™ï¼Œç‡ƒæ–™é”æ¨™å³å¯é€šé—œã€‚",
      "è£œçµ¦ä½¿ç”¨éçš„ç‰Œæœƒç§»å‡ºç‰Œåº«ï¼Œå†å¾ç‰Œåº«æŠ½ç‰Œè£œæ»¿æ‰‹ç‰Œã€‚",
      "é€²å…¥æ–°å¤§é—œæ™‚ï¼Œç§»å‡ºçš„ç‰Œæœƒè£œå……å›ç‰Œåº«ã€‚",
      "ä¸åŒæ˜Ÿçƒæœ‰ä¸åŒç‰¹æ€§ï¼Œé‡å°å…¶ç‰¹æ€§å–„ç”¨é“å…·å’Œè£œçµ¦çš„ç‰Œå‹èƒ½å¸¶ä¾†æ„æƒ³ä¸åˆ°çš„æ•ˆæœå“¦ï¼"
    ]
  },
  {
    title: "ä¸Ÿæ£„è¦å‰‡",
    body: [
      "æ¯é—œä¸Ÿæ£„æ¬¡æ•¸ä¸Šé™ 3 æ¬¡ (è‹¥ç„¡é“å…·åŠ æˆ)ã€‚",
      "æ¯æ¬¡ä¸Ÿæ£„æœ€å¤šé¸ 5 å¼µç‰Œã€‚",
      "ä¸Ÿæ£„çš„ç‰Œæœƒé‡å›ç‰Œåº«ï¼Œå†å¾ç‰Œåº«æŠ½ç‰Œè£œæ»¿æ‰‹ç‰Œã€‚"
    ]
  },
  {
    title: "å•†åº—",
    body: [
      "é€šé—œæ™‚æœƒç²å¾—é‡‘å¹£ï¼ŒåŒæ™‚å•†åº—æœƒåˆ·æ–°å•†å“ã€‚",
      "åˆ©ç”¨é‡‘å¹£è³¼è²·é“å…·å’Œæ¶ˆè€—å“ï¼Œè³¼è²·å¾Œç«‹å³ç”Ÿæ•ˆã€‚",
      "é“å…·ç‚ºæ°¸ä¹…æ•ˆæœï¼›æ¶ˆè€—å“ç‚ºä¸€æ¬¡æ€§ã€‚",
      "å·²æ“æœ‰çš„ç‰©å“å¯å‡ºå”®ï¼Œå”®åƒ¹ç‚ºè³¼è²·åƒ¹çš„ä¸€åŠï¼Œå‡ºå”®å¾Œå³å¤±æ•ˆã€‚"
    ]
  },
  // è¡¨æ ¼é 
  {
    title: "ç‰Œå‹å°æ‡‰ç‡ƒæ–™",
    table: {
      headers: ["ç‰Œå‹", "ç‡ƒæ–™", "åŠ æˆæ˜Ÿçƒ", "å€ç‡"],
      rows: [
        ["é«˜ç‰Œ", "15", "", ""],
        ["ä¸€å°", "25", "", ""],
        ["å…©å°", "35", "è¡›æ˜Ÿ", "1.5Ã—"],
        ["ä¸‰æ¢", "45", "çŸ®è¡Œæ˜Ÿ", "1.5Ã—"],
        ["é †å­", "55", "å²©çŸ³è¡Œæ˜Ÿ", "1.5Ã—"],
        ["åŒèŠ±", "60", "å†°å·¨è¡Œæ˜Ÿ", "1.5Ã—"],
        ["è‘«è˜†", "70", "æ°£é«”å·¨è¡Œæ˜Ÿ", "1.5Ã—"],
        ["éµæ”¯", "130", "", ""],
        ["åŒèŠ±é †", "220", "", ""],
        ["çš‡å®¶åŒèŠ±é †", "350", "", ""]
      ]
    }
  },
];
/* =========================================================
   è¦å‰‡ Overlayï¼ˆå¤šé ï¼‰
========================================================= */
const rulesBtn = document.getElementById('rules-btn');
const rulesOverlay = document.getElementById('rules-overlay');
const rulesClose = document.getElementById('rules-close');
const rulesPrev = document.getElementById('rules-prev');
const rulesNext = document.getElementById('rules-next');
const rulesBody = document.getElementById('rules-body');

let isRulesOpen = false;
let rulesPageIndex = 0;

function openRules(){
  isRulesOpen = true;
  rulesOverlay.classList.add('show');

  // æš«åœéŠæˆ² + ä¸è®“å•†åº—ç–Šé–‹
  setGamePaused(true);
  shopBtn.style.pointerEvents = 'none';

  // âœ… é‡è¦ï¼šé–‹çš„ç¬é–“å°± render
  renderRulesPages();
}

function closeRules(){
  isRulesOpen = false;
  rulesOverlay.classList.remove('show');

  shopBtn.style.pointerEvents = 'auto';

  // è‹¥å•†åº—é‚„é–‹è‘—å°±ç¶­æŒæš«åœï¼Œå¦å‰‡æ¢å¾©
  if(isShopOpen){
    setGamePaused(true);
  }else{
    setGamePaused(false);
  }
}
const rulesPageIndicator = document.getElementById('rules-page-indicator');

function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}

function renderRulesPages(){
  if(!rulesBody){
    console.warn('[Rules] #rules-body not found');
    return;
  }
  if(!RULE_PAGES || RULE_PAGES.length === 0){
    rulesBody.innerHTML = `<div style="opacity:0.8;">ï¼ˆå°šæœªè¨­å®šè¦å‰‡å…§å®¹ï¼‰</div>`;
    rulesPrev.disabled = true;
    rulesNext.disabled = true;
    rulesPageIndicator.textContent = `ç¬¬ 0 / 0 é `;
    return;
  }

  rulesPageIndex = Math.max(0, Math.min(rulesPageIndex, RULE_PAGES.length - 1));
  const page = RULE_PAGES[rulesPageIndex];

  // æ¨™é¡Œ
  let html = `
    <div style="font-size:1.25em; font-weight:800; color:#00ffcc; margin-bottom:10px;">
      ${escapeHtml(page.title)}
    </div>
  `;

  // å…§å®¹ï¼šè¡¨æ ¼ or æ–‡å­—
  if(page.table){
    const ths = page.table.headers.map(h => `<th>${escapeHtml(h)}</th>`).join('');
    const trs = page.table.rows.map(row=>{
      return `<tr>${row.map((cell,i)=>{
        const cls = (i === row.length - 1 && /^[0-9]/.test(String(cell))) ? 'num' : '';
        const isFuelCol = (i === 1); // ç¬¬äºŒæ¬„
        const className = [
          cls,
          isFuelCol ? 'num' : ''
        ].join(' ').trim();

        return `<td class="${className}">${escapeHtml(cell)}</td>`;

      }).join('')}</tr>`;
    }).join('');

    html += `
      <table class="rules-table">
        <thead><tr>${ths}</tr></thead>
        <tbody>${trs}</tbody>
      </table>
    `;
  }else{
    const lines = (page.body || []).map(t => `
    <div style="display:flex; gap:12px;">
          <span>â€¢</span>
          <span>${escapeHtml(t)}</span>
        </div>
    `).join('');
    html += `<div style="display:flex; flex-direction:column; gap:10px;">${lines}</div>`;
  }

  rulesBody.innerHTML = html;

  // é ç¢¼
  rulesPageIndicator.textContent = `ç¬¬ ${rulesPageIndex + 1} / ${RULE_PAGES.length} é `;

  rulesPrev.disabled = (rulesPageIndex === 0);
  rulesNext.disabled = (rulesPageIndex === RULE_PAGES.length - 1);
}

// äº‹ä»¶
rulesBtn.addEventListener('click', ()=>{
  if(isShopOpen) return;
  openRules();
});
rulesClose.addEventListener('click', closeRules);

rulesPrev.addEventListener('click', ()=>{
  if(rulesPageIndex <= 0) return;
  rulesPageIndex--;
  renderRulesPages();
});
rulesNext.addEventListener('click', ()=>{
  if(rulesPageIndex >= RULE_PAGES.length - 1) return;
  rulesPageIndex++;
  renderRulesPages();
});

window.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape' && isRulesOpen) closeRules();
});

/* =========================================================
   åˆå§‹åŒ–
========================================================= */
function loadProgress(){
  const raw = localStorage.getItem('gameState');
  return raw ? JSON.parse(raw) : null;
}

function applyProgress(state){
  // âœ… ç”¨ levelIndex ä½œç‚ºå”¯ä¸€é—œå¡å®šä½
  levelIndex = state.levelIndex ?? 0;

  // å–å‡ºè©²é—œè³‡æ–™ï¼ˆç‡ƒæ–™é–€æª»/å¤§é—œ/æ˜Ÿçƒå...ï¼‰
  const info = LEVELS[levelIndex] || LEVELS[0];

  bigStage = info.stage;

  // âœ… fuel / targetFuel
  fuel = state.fuel ?? 0;
  targetFuel = state.targetFuel ?? info.targetFuel; // ä»¥å­˜æª”ç‚ºä¸»ï¼Œæ²’æœ‰å°±ç”¨è¡¨

  bigStageClearCount = state.bigStageClearCount ?? 0;

  // âœ… HP / maxHPï¼ˆä¾ç•¶å‰å¤§é—œé‡æ–°è¨ˆç®—ï¼Œä¸¦æŠŠ hp å¤¾åœ¨ 0~maxHPï¼‰
  maxHP = computeMaxHP();
  hp = Math.max(0, state.hp ?? maxHP);

  // âœ… æ£„ç‰Œ / è£œçµ¦è¨ˆæ•¸ / æ‰‹ç‰Œä¸Šé™
  extraDiscards = state.extraDiscards ?? 0;
  discardsLeft = state.discardsLeft ?? (DISCARD_PER_LEVEL + extraDiscards);
  supplyCountInStage = state.supplyCountInStage ?? 0;
  HAND_SIZE = Math.min(state.HAND_SIZE ?? 8, HAND_SIZE_MAX);
  supplyBonusPerClear = state.supplyBonusPerClear ?? 0;

  // âœ… ç‰Œå †
  drawPile = state.drawPile ?? [];
  hand = state.hand ?? [];
  played = state.played ?? [];

  // âœ… é‡‘å¹£/å•†åº—/å·²æ“æœ‰
  coins = state.coins ?? coins; // coins è‹¥æœ‰é è¨­å€¼å°±ä¿ç•™
  shopTools = state.shopTools ?? shopTools;
  shopConsumables = state.shopConsumables ?? shopConsumables;

  // ownedTools/ownedConsumables è‹¥å·²ç¶“æ”¹æˆ Map+paid çµæ§‹ï¼Œæœƒéœ€è¦è½‰å› Map
  if(state.ownedTools) ownedToolsFromState(state.ownedTools);
  if(state.ownedConsumables) ownedConsumablesFromState(state.ownedConsumables);

  if(state.tempEffects){
    tempEffects = {
      nextSupplyNoRemove: !!state.tempEffects.nextSupplyNoRemove,
      nextSupplyHandRankPlus1: state.tempEffects.nextSupplyHandRankPlus1 ?? 0,
      nextSupplyFuelPctFromDiscard: state.tempEffects.nextSupplyFuelPctFromDiscard ?? 0,
      nextSupplyFuelMult: state.tempEffects.nextSupplyFuelMult ?? 1,
      nextSupplyLowHandBonus: state.tempEffects.nextSupplyLowHandBonus ?? 0,
      supplyHpOverride: state.tempEffects.supplyHpOverride ?? null,
    };
  }
}

function ownedToolsFromState(obj){
  ownedTools.clear();
  Object.entries(obj).forEach(([name, data])=>{
    ownedTools.set(name, { count: data.count, paid: data.paid || [] });
  });
}

function ownedConsumablesFromState(obj){
  ownedConsumables.clear();
  Object.entries(obj).forEach(([name, data])=>{
    ownedConsumables.set(name, { count: data.count, paid: data.paid || [] });
  });
}

function ownedToolsToState(){
  const out = {};
  ownedTools.forEach((v, k)=>{
    out[k] = { count: v.count || 0, paid: Array.isArray(v.paid) ? v.paid : [] };
  });
  return out;
}

function ownedConsumablesToState(){
  const out = {};
  ownedConsumables.forEach((v, k)=>{
    out[k] = { count: v.count || 0, paid: Array.isArray(v.paid) ? v.paid : [] };
  });
  return out;
}

let data = {};

function saveProgress(){
  const datasaved = {
    // é—œå¡å®šä½
    levelIndex,
    bigStage,

    // æ ¸å¿ƒæ•¸å€¼
    hp,
    maxHP,
    fuel,
    targetFuel,
    discardsLeft,
    extraDiscards,
    supplyCountInStage,
    HAND_SIZE,
    supplyBonusPerClear,
    bigStageClearCount,

    // ç‰Œå †
    drawPile,
    hand,
    played,

    // å•†åº— / ç¶“æ¿Ÿ
    coins,
    shopTools,
    shopConsumables,
    ownedTools: ownedToolsToState(),
    ownedConsumables: ownedConsumablesToState(),
    tempEffects,
  };

  data = datasaved;

  //localStorage.setItem('gameState', JSON.stringify(data));
}

function updateTopUILayout(){
  const hud = document.getElementById('hud-left');
  if(!hud) return;

  const rect = hud.getBoundingClientRect();
  // ä»¥è¦–çª—åº§æ¨™ç®— HUD åº•éƒ¨ï¼Œè½‰æˆã€Œè·é›¢ç•«é¢é ‚éƒ¨çš„ pxã€
  const bottom = Math.round(rect.bottom);

  document.documentElement.style.setProperty('--hud-bottom', `${bottom}px`);
}

// åˆæ¬¡ã€resizeã€ä»¥åŠå¯èƒ½è®Šå‹•æ™‚å‘¼å«
window.addEventListener('resize', updateTopUILayout);

// å¦‚æœ HUD å…§å®¹æœƒå› ç‚ºæ–‡å­—/æ•¸å€¼è®Šé•·è€Œæ›è¡Œï¼Œå»ºè­°ä¹Ÿç›£è½å®ƒ
const hudLeftEl = document.getElementById('hud-left');
if(hudLeftEl && 'ResizeObserver' in window){
  new ResizeObserver(updateTopUILayout).observe(hudLeftEl);
}

function boot(){
  //const state = loadProgress();
  const state = data;
  if(state && Object.keys(state).length > 0){
    applyProgress(state);
    if(shopTools.length === 0 && shopConsumables.length === 0){
      generateShopOffers();
    }
    // è‹¥æœ¬é æ˜¯æ–°ä¸€é—œçš„é–‹å§‹ï¼Œåœ¨é€™è£¡åšå¿…è¦çš„é‡ç½®ï¼ˆä¾‹å¦‚ï¼šè‹¥æ‰‹ç‰Œæ˜¯ç©ºçš„å°±è£œåˆ° HAND_SIZEï¼‰
    if(hand.length === 0){
      // ç¢ºä¿ç‰Œåº«å­˜åœ¨ï¼Œæ²’æœ‰å°±é‡ç½®
      if(!drawPile || drawPile.length === 0){
        drawPile = [...deck];
        shuffle(drawPile);
        played = [];
      }
      drawFromPile(HAND_SIZE);
    }
    renderHand();
    updateHUD();
  }else{
    // æ²’é€²åº¦ â†’ ç•¶æˆæ–°éŠæˆ²
    applyTestLevelOverride();
    startLevel();
  }
}

//localStorage.removeItem('gameState'); // æ¸¬è©¦å®Œè¦åˆª
boot();
updateTopUILayout();

/* =========================================================
   çŸ¥è­˜é 
========================================================= */

const stars = [
  {
    title: "æ°´æ˜Ÿ",
    knowledge: `æ°´æ˜Ÿæ˜¯å¤ªé™½ç³»ä¸­é›¢å¤ªé™½æœ€è¿‘ã€æœ€å°çš„è¡Œæ˜Ÿï¼Œç”šè‡³æ¯”ä¸€äº›è¡›æ˜Ÿé‚„å°ã€‚ç”±æ–¼ç¼ºä¹å¤§æ°£ï¼Œæ°´æ˜Ÿçš„æ—¥å¤œæº«å·®éå¸¸å¤§ï¼Œç™½å¤©æº«åº¦é«˜é” 400 åº¦ï¼Œæ™šä¸Šå‰‡æ˜¯é›¶ä¸‹ 180 åº¦ã€‚
    
    æ ¹æ“šä¿¡ä½¿è™Ÿçš„è§€æ¸¬ï¼Œæ°´æ˜Ÿæœ‰è‘—å…¨çƒæ€§ç£å ´ï¼Œç£å ´å¼·åº¦æ˜¯åœ°çƒçš„ 1%ã€‚ç£å ´çš„ä¾†æºæ¨æ¸¬æ˜¯å…¶å…§æ ¸å¯Œå«éµï¼Œè©³ç´°çµæœéœ€è¦ç­‰å¾…è²çš®å¯å€«å¡è™Ÿç¢ºèªã€‚`,
    link: [
      { text: "NASAï¼šMercury", url: "https://science.nasa.gov/mercury/facts/"},
      { text: "å±•ç¤ºå ´ 2 æ¨“ï¼šå¤ªé™½ç³»çµæ§‹", url: "https://sites.google.com/view/tamwebtp/%E4%BA%8C%E6%A8%93%E5%B1%95%E7%A4%BA%E5%8D%80_1/%E5%A4%AA%E9%99%BD%E7%B3%BB/%E5%A4%AA%E9%99%BD%E7%B3%BB%E7%B5%90%E6%A7%8B"},
      { text: "å±•ç¤ºå ´ 2 æ¨“ï¼šå¤ªé™½ç³»å…§å¤©é«”çš„å®šç¾©å’Œæˆå“¡", url: "https://sites.google.com/view/tamwebtp/%E4%BA%8C%E6%A8%93%E5%B1%95%E7%A4%BA%E5%8D%80_1/%E5%A4%AA%E9%99%BD%E7%B3%BB/%E5%A4%AA%E9%99%BD%E7%B3%BB%E5%85%A7%E5%A4%A9%E9%AB%94%E7%9A%84%E5%AE%9A%E7%BE%A9%E5%92%8C%E6%88%90%E5%93%A1"},
      { text: "å¤©æ–‡æ–°çŸ¥ï¼šå¤ªé™½ç³»å…§å¯èƒ½æ“æœ‰é‘½çŸ³å±¤çš„è¡Œæ˜Ÿ", url: "https://tam.gov.taipei/News_Content.aspx?n=EF86D8AF23B9A85B&sms=F32C4FF0AC5C2801&s=D2A26E8BF434225E"},
      { text: "å¤©æ–‡æ–°çŸ¥ï¼šè²çš®å¯å€«å¡è™Ÿç¬¬6æ¬¡é£›æ æ°´æ˜Ÿçš„3å¼µæœ€ä½³å½±åƒ", url: "https://tam.gov.taipei/News_Content.aspx?n=EF86D8AF23B9A85B&sms=F32C4FF0AC5C2801&s=F8DBCA7D9D43C951"}
    ]
  },
  {
    title: "é‡‘æ˜Ÿ",
    knowledge: `é‡‘æ˜Ÿæ˜¯é›¢å¤ªé™½ç¬¬äºŒè¿‘çš„è¡Œæ˜Ÿï¼Œå®ƒè·Ÿåœ°çƒå·®ä¸å¤šå¤§ï¼Œè³ªé‡æ˜¯åœ°çƒçš„ 0.8 å€ï¼ŒåŠå¾‘æ˜¯åœ°çƒçš„ 0.95å€ã€‚
    
    é‡‘æ˜Ÿæœ‰è‘—æ¿ƒåšçš„å¤§æ°£å±¤ï¼Œå¤§æ°£å£“åŠ›æ˜¯åœ°çƒçš„ 90 å€ï¼Œå¤§æ°£ä¸­æœ‰ 96% æ˜¯äºŒæ°§åŒ–ç¢³ï¼Œä½¿æº«å®¤æ•ˆæ‡‰éå¸¸åš´é‡ï¼Œæ‰€ä»¥é‡‘æ˜Ÿè¡¨é¢æº«åº¦ç”šè‡³æ¯”æ°´æ˜Ÿé‚„é«˜ã€‚
    
    æ ¹æ“šç ´æ›‰è™Ÿçš„è§€æ¸¬ï¼Œé‡‘æ˜Ÿå¤§æ°£ä¸­é‚„æœ‰ç¡«é…¸å½¢æˆçš„ç¡«é…¸é›²ï¼Œæ‰€ä»¥é‡‘æ˜Ÿä¸‹é›¨çš„è©±æœƒä¸‹ç¡«é…¸é›¨ï¼`,
    link: [
      { text: "NASAï¼šVenus", url: "https://science.nasa.gov/venus/venus-facts/"},
      { text: "å±•ç¤ºå ´ 2 æ¨“ï¼šå¤ªé™½ç³»çµæ§‹", url: "https://sites.google.com/view/tamwebtp/%E4%BA%8C%E6%A8%93%E5%B1%95%E7%A4%BA%E5%8D%80_1/%E5%A4%AA%E9%99%BD%E7%B3%BB/%E5%A4%AA%E9%99%BD%E7%B3%BB%E7%B5%90%E6%A7%8B"},
      { text: "å±•ç¤ºå ´ 2 æ¨“ï¼šå¤ªé™½ç³»å…§å¤©é«”çš„å®šç¾©å’Œæˆå“¡", url: "https://sites.google.com/view/tamwebtp/%E4%BA%8C%E6%A8%93%E5%B1%95%E7%A4%BA%E5%8D%80_1/%E5%A4%AA%E9%99%BD%E7%B3%BB/%E5%A4%AA%E9%99%BD%E7%B3%BB%E5%85%A7%E5%A4%A9%E9%AB%94%E7%9A%84%E5%AE%9A%E7%BE%A9%E5%92%8C%E6%88%90%E5%93%A1"},
      { text: "å¤©æ–‡æ–°çŸ¥ï¼šé‡‘æ˜Ÿä¸Šå¯èƒ½æœ‰ç”Ÿå‘½å—ï¼Ÿå¾é›²å±¤ä¸­å†æ¬¡è§€æ¸¬åˆ°ç£·åŒ–æ°«", url: "https://tam.gov.taipei/News_Content.aspx?n=EF86D8AF23B9A85B&sms=F32C4FF0AC5C2801&s=08A02B9FA085A117"},
      { text: "å¤©æ–‡æ–°çŸ¥ï¼šNASAç ”ç©¶æ­ç¤ºé‡‘æ˜Ÿåœ°æ®¼é©šäººç§˜å¯†", url: "https://tam.gov.taipei/News_Content.aspx?n=EF86D8AF23B9A85B&sms=F32C4FF0AC5C2801&s=F0494914063D6733"}
    ]
  },
  {
    title: "åœ°çƒ",
    knowledge: `åœ°çƒæ˜¯é›¢å¤ªé™½ç¬¬ä¸‰è¿‘çš„è¡Œæ˜Ÿï¼Œä¹Ÿæ˜¯ä¸€é¡†ç¾éº—ä¸”æœ‰è‘—ç”Ÿå‘½çš„è¡Œæ˜Ÿã€‚
    
    ç§‘å­¸å®¶åˆ°ç›®å‰ç‚ºæ­¢éƒ½é‚„æ²’åœ¨åœ°çƒä»¥å¤–çš„åœ°æ–¹ç™¼ç¾éç”Ÿå‘½ï¼Œæ›´åˆ¥ææ™ºæ…§æ–‡æ˜äº†ã€‚ä¸éï¼Œå¤©æ–‡å­¸å®¶å¾·ç‘å…‹æå‡ºäº†ã€Œå¾·ç‘å…‹æ–¹ç¨‹å¼ã€ä¾†ä¼°è¨ˆéŠ€æ²³ç³»ä¸­å¯èƒ½å­˜åœ¨çš„é«˜ç­‰æ™ºæ…§æ–‡æ˜æ•¸é‡`,
    link: [
      { text: "å±•ç¤ºå ´ 1 æ¨“ï¼šåœ°çƒ", url: "https://sites.google.com/view/tamwebtp/%E4%B8%80%E6%A8%93%E5%B1%95%E7%A4%BA%E5%8D%80_1/%E5%9C%B0%E7%90%83"},
      { text: "å±•ç¤ºå ´ 3 æ¨“ï¼šå¾·ç‘å…‹æ–¹ç¨‹å¼", url: "https://sites.google.com/view/tamwebtp/%E4%B8%89%E6%A8%93%E5%B1%95%E7%A4%BA%E5%8D%80_1/%E6%8E%A2%E7%B4%A2%E5%A4%96%E6%98%9F%E7%94%9F%E5%91%BD/%E5%BE%B7%E7%91%9E%E5%85%8B%E6%96%B9%E7%A8%8B%E5%BC%8F"}
    ]
  },
  {
    title: "ç«æ˜Ÿ",
    knowledge: `ç«æ˜Ÿæ˜¯é›¢å¤ªé™½ç¬¬å››è¿‘çš„è¡Œæ˜Ÿï¼Œä¹Ÿæ˜¯ç¹¼æœˆçƒå¾Œï¼Œç§‘å­¸å®¶æ¢ç´¢çš„ä¸‹ä¸€å€‹ç›®æ¨™ã€‚
    
    éš¨è‘—é˜¿æç±³çµ²è¨ˆåŠƒçš„æ¨é€²ï¼Œäººé¡å°‡é¦–å…ˆåœ¨æœˆçƒä¸Šå»ºç«‹åŸºåœ°ã€‚é€™ä¸åƒ…æ˜¯ç‚ºäº†ç§‘å­¸ç ”ç©¶ï¼Œæ›´æ˜¯ç‚ºäº†ç™»é™¸ç«æ˜Ÿï¼Œæ‰“é€ äººé¡æœªä¾†å¯èƒ½çš„åœ°å¤–å®¶åœ’ï¼`,
    link: [
      { text: "NASAï¼šMars", url: "https://science.nasa.gov/mars/facts/"},
      { text: "NASAï¼šé˜¿æç±³çµ²è¨ˆç•«", url: "https://www.nasa.gov/reference/artemis-i-2/"},
      { text: "å¤©æ–‡æ–°çŸ¥ï¼šé˜¿æç±³çµ²ä»»å‹™å°‡è¿ä¾†å¤ªç©ºåœ˜éšŠçš„æ–°ç´€å…ƒ", url: "https://tam.gov.taipei/News_Content.aspx?n=EF86D8AF23B9A85B&sms=F32C4FF0AC5C2801&s=4206B349FF3C2D45"},
      { text: "å¤©æ–‡æ–°çŸ¥ï¼šæˆ‘å€‘å°ç«æ˜Ÿç‚ºä½•å‘ˆç´…è‰²çš„ç†è§£éŒ¯äº†å—ï¼Ÿ", url: "https://tam.gov.taipei/News_Content.aspx?n=EF86D8AF23B9A85B&sms=F32C4FF0AC5C2801&s=A732AA24CE9BDCD2"},
      { text: "å¤©æ–‡æ–°çŸ¥ï¼šç«æ˜Ÿåœ°ä¸‹æœ‰æµ·æ´‹ï¼Ÿæœ€æ–°ç ”ç©¶å†åº¦æ”¯æŒåœ°ä¸‹æ°´åº«å­˜åœ¨", url: "https://tam.gov.taipei/News_Content.aspx?n=EF86D8AF23B9A85B&sms=F32C4FF0AC5C2801&s=882F57BFC2FAA7C4"},
      { text: "å¤©æ–‡æ–°çŸ¥ï¼šåœ¨ç«æ˜Ÿåœ°è¡¨é¦–åº¦è§€æ¸¬åˆ°å¯è¦‹å…‰æ³¢æ®µçš„ç¶ è‰²æ¥µå…‰", url: "https://tam.gov.taipei/News_Content.aspx?n=EF86D8AF23B9A85B&sms=F32C4FF0AC5C2801&s=D694D552027F0520"}
    ]
  },
  {
    title: "æœ¨æ˜Ÿ",
    knowledge: `ç«æ˜Ÿæ˜¯é›¢å¤ªé™½ç¬¬å››è¿‘çš„è¡Œæ˜Ÿï¼Œä¹Ÿæ˜¯ç¹¼æœˆçƒå¾Œï¼Œç§‘å­¸å®¶æ¢ç´¢çš„ä¸‹ä¸€å€‹ç›®æ¨™ã€‚
    
    éš¨è‘—é˜¿æç±³çµ²è¨ˆåŠƒçš„æ¨é€²ï¼Œäººé¡å°‡é¦–å…ˆåœ¨æœˆçƒä¸Šå»ºç«‹åŸºåœ°ã€‚é€™ä¸åƒ…æ˜¯ç‚ºäº†ç§‘å­¸ç ”ç©¶ï¼Œæ›´æ˜¯ç‚ºäº†ç™»é™¸ç«æ˜Ÿï¼Œæ‰“é€ äººé¡æœªä¾†å¯èƒ½çš„åœ°å¤–å®¶åœ’ï¼`,
    link: [
      { text: "NASAï¼šMars", url: "https://science.nasa.gov/mars/facts/"},
      { text: "NASAï¼šé˜¿æç±³çµ²è¨ˆç•«", url: "https://www.nasa.gov/reference/artemis-i-2/"},
      { text: "å¤©æ–‡æ–°çŸ¥ï¼šé˜¿æç±³çµ²ä»»å‹™å°‡è¿ä¾†å¤ªç©ºåœ˜éšŠçš„æ–°ç´€å…ƒ", url: "https://tam.gov.taipei/News_Content.aspx?n=EF86D8AF23B9A85B&sms=F32C4FF0AC5C2801&s=4206B349FF3C2D45"},
      { text: "å¤©æ–‡æ–°çŸ¥ï¼šæˆ‘å€‘å°ç«æ˜Ÿç‚ºä½•å‘ˆç´…è‰²çš„ç†è§£éŒ¯äº†å—ï¼Ÿ", url: "https://tam.gov.taipei/News_Content.aspx?n=EF86D8AF23B9A85B&sms=F32C4FF0AC5C2801&s=A732AA24CE9BDCD2"},
      { text: "å¤©æ–‡æ–°çŸ¥ï¼šç«æ˜Ÿåœ°ä¸‹æœ‰æµ·æ´‹ï¼Ÿæœ€æ–°ç ”ç©¶å†åº¦æ”¯æŒåœ°ä¸‹æ°´åº«å­˜åœ¨", url: "https://tam.gov.taipei/News_Content.aspx?n=EF86D8AF23B9A85B&sms=F32C4FF0AC5C2801&s=882F57BFC2FAA7C4"},
      { text: "å¤©æ–‡æ–°çŸ¥ï¼šåœ¨ç«æ˜Ÿåœ°è¡¨é¦–åº¦è§€æ¸¬åˆ°å¯è¦‹å…‰æ³¢æ®µçš„ç¶ è‰²æ¥µå…‰", url: "https://tam.gov.taipei/News_Content.aspx?n=EF86D8AF23B9A85B&sms=F32C4FF0AC5C2801&s=D694D552027F0520"}
    ]
  },
  {
    title: "è‰¾æ­",
    knowledge: `ç«æ˜Ÿæ˜¯é›¢å¤ªé™½ç¬¬å››è¿‘çš„è¡Œæ˜Ÿï¼Œä¹Ÿæ˜¯ç¹¼æœˆçƒå¾Œï¼Œç§‘å­¸å®¶æ¢ç´¢çš„ä¸‹ä¸€å€‹ç›®æ¨™ã€‚
    
    éš¨è‘—é˜¿æç±³çµ²è¨ˆåŠƒçš„æ¨é€²ï¼Œäººé¡å°‡é¦–å…ˆåœ¨æœˆçƒä¸Šå»ºç«‹åŸºåœ°ã€‚é€™ä¸åƒ…æ˜¯ç‚ºäº†ç§‘å­¸ç ”ç©¶ï¼Œæ›´æ˜¯ç‚ºäº†ç™»é™¸ç«æ˜Ÿï¼Œæ‰“é€ äººé¡æœªä¾†å¯èƒ½çš„åœ°å¤–å®¶åœ’ï¼`,
    link: [
      { text: "NASAï¼šMars", url: "https://science.nasa.gov/mars/facts/"},
      { text: "NASAï¼šé˜¿æç±³çµ²è¨ˆç•«", url: "https://www.nasa.gov/reference/artemis-i-2/"},
      { text: "å¤©æ–‡æ–°çŸ¥ï¼šé˜¿æç±³çµ²ä»»å‹™å°‡è¿ä¾†å¤ªç©ºåœ˜éšŠçš„æ–°ç´€å…ƒ", url: "https://tam.gov.taipei/News_Content.aspx?n=EF86D8AF23B9A85B&sms=F32C4FF0AC5C2801&s=4206B349FF3C2D45"},
      { text: "å¤©æ–‡æ–°çŸ¥ï¼šæˆ‘å€‘å°ç«æ˜Ÿç‚ºä½•å‘ˆç´…è‰²çš„ç†è§£éŒ¯äº†å—ï¼Ÿ", url: "https://tam.gov.taipei/News_Content.aspx?n=EF86D8AF23B9A85B&sms=F32C4FF0AC5C2801&s=A732AA24CE9BDCD2"},
      { text: "å¤©æ–‡æ–°çŸ¥ï¼šç«æ˜Ÿåœ°ä¸‹æœ‰æµ·æ´‹ï¼Ÿæœ€æ–°ç ”ç©¶å†åº¦æ”¯æŒåœ°ä¸‹æ°´åº«å­˜åœ¨", url: "https://tam.gov.taipei/News_Content.aspx?n=EF86D8AF23B9A85B&sms=F32C4FF0AC5C2801&s=882F57BFC2FAA7C4"},
      { text: "å¤©æ–‡æ–°çŸ¥ï¼šåœ¨ç«æ˜Ÿåœ°è¡¨é¦–åº¦è§€æ¸¬åˆ°å¯è¦‹å…‰æ³¢æ®µçš„ç¶ è‰²æ¥µå…‰", url: "https://tam.gov.taipei/News_Content.aspx?n=EF86D8AF23B9A85B&sms=F32C4FF0AC5C2801&s=D694D552027F0520"}
    ]
  },
  {
    title: "æ­ç¾…å·´",
    knowledge: `ç«æ˜Ÿæ˜¯é›¢å¤ªé™½ç¬¬å››è¿‘çš„è¡Œæ˜Ÿï¼Œä¹Ÿæ˜¯ç¹¼æœˆçƒå¾Œï¼Œç§‘å­¸å®¶æ¢ç´¢çš„ä¸‹ä¸€å€‹ç›®æ¨™ã€‚
    
    éš¨è‘—é˜¿æç±³çµ²è¨ˆåŠƒçš„æ¨é€²ï¼Œäººé¡å°‡é¦–å…ˆåœ¨æœˆçƒä¸Šå»ºç«‹åŸºåœ°ã€‚é€™ä¸åƒ…æ˜¯ç‚ºäº†ç§‘å­¸ç ”ç©¶ï¼Œæ›´æ˜¯ç‚ºäº†ç™»é™¸ç«æ˜Ÿï¼Œæ‰“é€ äººé¡æœªä¾†å¯èƒ½çš„åœ°å¤–å®¶åœ’ï¼`,
    link: [
      { text: "NASAï¼šMars", url: "https://science.nasa.gov/mars/facts/"},
      { text: "NASAï¼šé˜¿æç±³çµ²è¨ˆç•«", url: "https://www.nasa.gov/reference/artemis-i-2/"},
      { text: "å¤©æ–‡æ–°çŸ¥ï¼šé˜¿æç±³çµ²ä»»å‹™å°‡è¿ä¾†å¤ªç©ºåœ˜éšŠçš„æ–°ç´€å…ƒ", url: "https://tam.gov.taipei/News_Content.aspx?n=EF86D8AF23B9A85B&sms=F32C4FF0AC5C2801&s=4206B349FF3C2D45"},
      { text: "å¤©æ–‡æ–°çŸ¥ï¼šæˆ‘å€‘å°ç«æ˜Ÿç‚ºä½•å‘ˆç´…è‰²çš„ç†è§£éŒ¯äº†å—ï¼Ÿ", url: "https://tam.gov.taipei/News_Content.aspx?n=EF86D8AF23B9A85B&sms=F32C4FF0AC5C2801&s=A732AA24CE9BDCD2"},
      { text: "å¤©æ–‡æ–°çŸ¥ï¼šç«æ˜Ÿåœ°ä¸‹æœ‰æµ·æ´‹ï¼Ÿæœ€æ–°ç ”ç©¶å†åº¦æ”¯æŒåœ°ä¸‹æ°´åº«å­˜åœ¨", url: "https://tam.gov.taipei/News_Content.aspx?n=EF86D8AF23B9A85B&sms=F32C4FF0AC5C2801&s=882F57BFC2FAA7C4"},
      { text: "å¤©æ–‡æ–°çŸ¥ï¼šåœ¨ç«æ˜Ÿåœ°è¡¨é¦–åº¦è§€æ¸¬åˆ°å¯è¦‹å…‰æ³¢æ®µçš„ç¶ è‰²æ¥µå…‰", url: "https://tam.gov.taipei/News_Content.aspx?n=EF86D8AF23B9A85B&sms=F32C4FF0AC5C2801&s=D694D552027F0520"}
    ]
  },
  {
    title: "åœŸæ˜Ÿ",
    knowledge: `ç«æ˜Ÿæ˜¯é›¢å¤ªé™½ç¬¬å››è¿‘çš„è¡Œæ˜Ÿï¼Œä¹Ÿæ˜¯ç¹¼æœˆçƒå¾Œï¼Œç§‘å­¸å®¶æ¢ç´¢çš„ä¸‹ä¸€å€‹ç›®æ¨™ã€‚
    
    éš¨è‘—é˜¿æç±³çµ²è¨ˆåŠƒçš„æ¨é€²ï¼Œäººé¡å°‡é¦–å…ˆåœ¨æœˆçƒä¸Šå»ºç«‹åŸºåœ°ã€‚é€™ä¸åƒ…æ˜¯ç‚ºäº†ç§‘å­¸ç ”ç©¶ï¼Œæ›´æ˜¯ç‚ºäº†ç™»é™¸ç«æ˜Ÿï¼Œæ‰“é€ äººé¡æœªä¾†å¯èƒ½çš„åœ°å¤–å®¶åœ’ï¼`,
    link: [
      { text: "NASAï¼šMars", url: "https://science.nasa.gov/mars/facts/"},
      { text: "NASAï¼šé˜¿æç±³çµ²è¨ˆç•«", url: "https://www.nasa.gov/reference/artemis-i-2/"},
      { text: "å¤©æ–‡æ–°çŸ¥ï¼šé˜¿æç±³çµ²ä»»å‹™å°‡è¿ä¾†å¤ªç©ºåœ˜éšŠçš„æ–°ç´€å…ƒ", url: "https://tam.gov.taipei/News_Content.aspx?n=EF86D8AF23B9A85B&sms=F32C4FF0AC5C2801&s=4206B349FF3C2D45"},
      { text: "å¤©æ–‡æ–°çŸ¥ï¼šæˆ‘å€‘å°ç«æ˜Ÿç‚ºä½•å‘ˆç´…è‰²çš„ç†è§£éŒ¯äº†å—ï¼Ÿ", url: "https://tam.gov.taipei/News_Content.aspx?n=EF86D8AF23B9A85B&sms=F32C4FF0AC5C2801&s=A732AA24CE9BDCD2"},
      { text: "å¤©æ–‡æ–°çŸ¥ï¼šç«æ˜Ÿåœ°ä¸‹æœ‰æµ·æ´‹ï¼Ÿæœ€æ–°ç ”ç©¶å†åº¦æ”¯æŒåœ°ä¸‹æ°´åº«å­˜åœ¨", url: "https://tam.gov.taipei/News_Content.aspx?n=EF86D8AF23B9A85B&sms=F32C4FF0AC5C2801&s=882F57BFC2FAA7C4"},
      { text: "å¤©æ–‡æ–°çŸ¥ï¼šåœ¨ç«æ˜Ÿåœ°è¡¨é¦–åº¦è§€æ¸¬åˆ°å¯è¦‹å…‰æ³¢æ®µçš„ç¶ è‰²æ¥µå…‰", url: "https://tam.gov.taipei/News_Content.aspx?n=EF86D8AF23B9A85B&sms=F32C4FF0AC5C2801&s=D694D552027F0520"}
    ]
  },
  {
    title: "å¤©ç‹æ˜Ÿ",
    knowledge: `ç«æ˜Ÿæ˜¯é›¢å¤ªé™½ç¬¬å››è¿‘çš„è¡Œæ˜Ÿï¼Œä¹Ÿæ˜¯ç¹¼æœˆçƒå¾Œï¼Œç§‘å­¸å®¶æ¢ç´¢çš„ä¸‹ä¸€å€‹ç›®æ¨™ã€‚
    
    éš¨è‘—é˜¿æç±³çµ²è¨ˆåŠƒçš„æ¨é€²ï¼Œäººé¡å°‡é¦–å…ˆåœ¨æœˆçƒä¸Šå»ºç«‹åŸºåœ°ã€‚é€™ä¸åƒ…æ˜¯ç‚ºäº†ç§‘å­¸ç ”ç©¶ï¼Œæ›´æ˜¯ç‚ºäº†ç™»é™¸ç«æ˜Ÿï¼Œæ‰“é€ äººé¡æœªä¾†å¯èƒ½çš„åœ°å¤–å®¶åœ’ï¼`,
    link: [
      { text: "NASAï¼šMars", url: "https://science.nasa.gov/mars/facts/"},
      { text: "NASAï¼šé˜¿æç±³çµ²è¨ˆç•«", url: "https://www.nasa.gov/reference/artemis-i-2/"},
      { text: "å¤©æ–‡æ–°çŸ¥ï¼šé˜¿æç±³çµ²ä»»å‹™å°‡è¿ä¾†å¤ªç©ºåœ˜éšŠçš„æ–°ç´€å…ƒ", url: "https://tam.gov.taipei/News_Content.aspx?n=EF86D8AF23B9A85B&sms=F32C4FF0AC5C2801&s=4206B349FF3C2D45"},
      { text: "å¤©æ–‡æ–°çŸ¥ï¼šæˆ‘å€‘å°ç«æ˜Ÿç‚ºä½•å‘ˆç´…è‰²çš„ç†è§£éŒ¯äº†å—ï¼Ÿ", url: "https://tam.gov.taipei/News_Content.aspx?n=EF86D8AF23B9A85B&sms=F32C4FF0AC5C2801&s=A732AA24CE9BDCD2"},
      { text: "å¤©æ–‡æ–°çŸ¥ï¼šç«æ˜Ÿåœ°ä¸‹æœ‰æµ·æ´‹ï¼Ÿæœ€æ–°ç ”ç©¶å†åº¦æ”¯æŒåœ°ä¸‹æ°´åº«å­˜åœ¨", url: "https://tam.gov.taipei/News_Content.aspx?n=EF86D8AF23B9A85B&sms=F32C4FF0AC5C2801&s=882F57BFC2FAA7C4"},
      { text: "å¤©æ–‡æ–°çŸ¥ï¼šåœ¨ç«æ˜Ÿåœ°è¡¨é¦–åº¦è§€æ¸¬åˆ°å¯è¦‹å…‰æ³¢æ®µçš„ç¶ è‰²æ¥µå…‰", url: "https://tam.gov.taipei/News_Content.aspx?n=EF86D8AF23B9A85B&sms=F32C4FF0AC5C2801&s=D694D552027F0520"}
    ]
  },
  {
    title: "æµ·ç‹æ˜Ÿ",
    knowledge: `ç«æ˜Ÿæ˜¯é›¢å¤ªé™½ç¬¬å››è¿‘çš„è¡Œæ˜Ÿï¼Œä¹Ÿæ˜¯ç¹¼æœˆçƒå¾Œï¼Œç§‘å­¸å®¶æ¢ç´¢çš„ä¸‹ä¸€å€‹ç›®æ¨™ã€‚
    
    éš¨è‘—é˜¿æç±³çµ²è¨ˆåŠƒçš„æ¨é€²ï¼Œäººé¡å°‡é¦–å…ˆåœ¨æœˆçƒä¸Šå»ºç«‹åŸºåœ°ã€‚é€™ä¸åƒ…æ˜¯ç‚ºäº†ç§‘å­¸ç ”ç©¶ï¼Œæ›´æ˜¯ç‚ºäº†ç™»é™¸ç«æ˜Ÿï¼Œæ‰“é€ äººé¡æœªä¾†å¯èƒ½çš„åœ°å¤–å®¶åœ’ï¼`,
    link: [
      { text: "NASAï¼šMars", url: "https://science.nasa.gov/mars/facts/"},
      { text: "NASAï¼šé˜¿æç±³çµ²è¨ˆç•«", url: "https://www.nasa.gov/reference/artemis-i-2/"},
      { text: "å¤©æ–‡æ–°çŸ¥ï¼šé˜¿æç±³çµ²ä»»å‹™å°‡è¿ä¾†å¤ªç©ºåœ˜éšŠçš„æ–°ç´€å…ƒ", url: "https://tam.gov.taipei/News_Content.aspx?n=EF86D8AF23B9A85B&sms=F32C4FF0AC5C2801&s=4206B349FF3C2D45"},
      { text: "å¤©æ–‡æ–°çŸ¥ï¼šæˆ‘å€‘å°ç«æ˜Ÿç‚ºä½•å‘ˆç´…è‰²çš„ç†è§£éŒ¯äº†å—ï¼Ÿ", url: "https://tam.gov.taipei/News_Content.aspx?n=EF86D8AF23B9A85B&sms=F32C4FF0AC5C2801&s=A732AA24CE9BDCD2"},
      { text: "å¤©æ–‡æ–°çŸ¥ï¼šç«æ˜Ÿåœ°ä¸‹æœ‰æµ·æ´‹ï¼Ÿæœ€æ–°ç ”ç©¶å†åº¦æ”¯æŒåœ°ä¸‹æ°´åº«å­˜åœ¨", url: "https://tam.gov.taipei/News_Content.aspx?n=EF86D8AF23B9A85B&sms=F32C4FF0AC5C2801&s=882F57BFC2FAA7C4"},
      { text: "å¤©æ–‡æ–°çŸ¥ï¼šåœ¨ç«æ˜Ÿåœ°è¡¨é¦–åº¦è§€æ¸¬åˆ°å¯è¦‹å…‰æ³¢æ®µçš„ç¶ è‰²æ¥µå…‰", url: "https://tam.gov.taipei/News_Content.aspx?n=EF86D8AF23B9A85B&sms=F32C4FF0AC5C2801&s=D694D552027F0520"}
    ]
  },
  {
    title: "å†¥ç‹æ˜Ÿ",
    knowledge: `ç«æ˜Ÿæ˜¯é›¢å¤ªé™½ç¬¬å››è¿‘çš„è¡Œæ˜Ÿï¼Œä¹Ÿæ˜¯ç¹¼æœˆçƒå¾Œï¼Œç§‘å­¸å®¶æ¢ç´¢çš„ä¸‹ä¸€å€‹ç›®æ¨™ã€‚
    
    éš¨è‘—é˜¿æç±³çµ²è¨ˆåŠƒçš„æ¨é€²ï¼Œäººé¡å°‡é¦–å…ˆåœ¨æœˆçƒä¸Šå»ºç«‹åŸºåœ°ã€‚é€™ä¸åƒ…æ˜¯ç‚ºäº†ç§‘å­¸ç ”ç©¶ï¼Œæ›´æ˜¯ç‚ºäº†ç™»é™¸ç«æ˜Ÿï¼Œæ‰“é€ äººé¡æœªä¾†å¯èƒ½çš„åœ°å¤–å®¶åœ’ï¼`,
    link: [
      { text: "NASAï¼šMars", url: "https://science.nasa.gov/mars/facts/"},
      { text: "NASAï¼šé˜¿æç±³çµ²è¨ˆç•«", url: "https://www.nasa.gov/reference/artemis-i-2/"},
      { text: "å¤©æ–‡æ–°çŸ¥ï¼šé˜¿æç±³çµ²ä»»å‹™å°‡è¿ä¾†å¤ªç©ºåœ˜éšŠçš„æ–°ç´€å…ƒ", url: "https://tam.gov.taipei/News_Content.aspx?n=EF86D8AF23B9A85B&sms=F32C4FF0AC5C2801&s=4206B349FF3C2D45"},
      { text: "å¤©æ–‡æ–°çŸ¥ï¼šæˆ‘å€‘å°ç«æ˜Ÿç‚ºä½•å‘ˆç´…è‰²çš„ç†è§£éŒ¯äº†å—ï¼Ÿ", url: "https://tam.gov.taipei/News_Content.aspx?n=EF86D8AF23B9A85B&sms=F32C4FF0AC5C2801&s=A732AA24CE9BDCD2"},
      { text: "å¤©æ–‡æ–°çŸ¥ï¼šç«æ˜Ÿåœ°ä¸‹æœ‰æµ·æ´‹ï¼Ÿæœ€æ–°ç ”ç©¶å†åº¦æ”¯æŒåœ°ä¸‹æ°´åº«å­˜åœ¨", url: "https://tam.gov.taipei/News_Content.aspx?n=EF86D8AF23B9A85B&sms=F32C4FF0AC5C2801&s=882F57BFC2FAA7C4"},
      { text: "å¤©æ–‡æ–°çŸ¥ï¼šåœ¨ç«æ˜Ÿåœ°è¡¨é¦–åº¦è§€æ¸¬åˆ°å¯è¦‹å…‰æ³¢æ®µçš„ç¶ è‰²æ¥µå…‰", url: "https://tam.gov.taipei/News_Content.aspx?n=EF86D8AF23B9A85B&sms=F32C4FF0AC5C2801&s=D694D552027F0520"}
    ]
  }
]

function renderStar(index) {
  closePassModal();
  document.getElementById("game-screen").classList.add("hidden");
  document.getElementById("info-screen").classList.remove("hidden");

  const star = stars[index];

  document.getElementById("knowledge-title").textContent = star.title;
  document.getElementById("knowledge-text").innerHTML = formatknowledge(star.knowledge);

  // é€£çµè™•ç†
  const linkArea = document.getElementById("info-link");
  const info = stars[index];
  const link = info && info.link;
  if (link) {
    linkArea.innerHTML = "<p>ç›¸é—œå…§å®¹</p>";

    if (Array.isArray(link)) { // å¤šå€‹ç¶²å€
      link.forEach(l => {
        linkArea.innerHTML += `<a href="${l.url}" target="_blank" style="display:block; color:#00ccff;">${l.text}</a>`;
      });
    }
    else if (link.url && link.text) { // å–®ä¸€ç¶²å€
      linkArea.innerHTML += `<a href="${link.url}" target="_blank" style="display:block; color:#00ccff;">${link.text}</a>`;
    }
    linkArea.classList.remove("hidden");
  } else { // æ²’æœ‰ç¶²å€
    linkArea.innerHTML = "";
    linkArea.classList.add("hidden");
  }
}

function nextStar() {
  const prevStage = LEVELS[levelIndex]?.stage ?? null;
  levelIndex += 1;
  resetLevelState();
  const nextStage = LEVELS[levelIndex]?.stage ?? null;
  if(prevStage && nextStage && prevStage !== nextStage){
    initBigStageResetDeck();
    hand = [];
    supplyCountInStage = 0;
  }
  saveProgress();

  document.getElementById("info-screen").classList.add("hidden");

  if (data.levelIndex > 10) {
    document.getElementById("final-screen").classList.remove("hidden");
    document.getElementById("endscore-display").textContent = 'ä½ çš„æˆç¸¾ï¼šé—–å‡ºå¤ªé™½ç³»';
  } else {
    document.getElementById("game-screen").classList.remove("hidden");
    boot();
  }
}

function formatknowledge(knowledge) {
  return knowledge
  .replace(/\n/g, '<br>') // è‹¥ä½  intro è£¡æ˜¯ç”¨æ›è¡Œç¬¦è™Ÿæ–·è¡Œï¼Œä¹Ÿå¯ä»¥åŠ é€™è¡Œ
  .replace(/\s{2,}/g, ''); // æ¸…é™¤å¤šé¤˜ç©ºç™½
}

</script>

</body>
</html>